<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Ocorrências Escolares</title>

  <!-- Ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

  <!-- Highcharts (Rosca/Pizza 3D) -->
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/highcharts-3d.js"></script>
  <script src="https://code.highcharts.com/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/accessibility.js"></script>

  <!-- XLSX p/ Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- jsPDF + autotable p/ PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{
      --primary:#1a73e8; --primary-dark:#0d47a1;
      --bg:#f5f7fa; --card:#fff; --text:#202124; --muted:#5f6368;
      --ok:#2ecc71; --warn:#f1c40f; --danger:#e74c3c; --border:#e5e7eb;
      --shadow:0 6px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:400 16px/1.5 "Segoe UI",Roboto,Arial,sans-serif}
    header{background:linear-gradient(135deg,#2ecc71 0%,#3498db 100%);color:#fff;box-shadow:var(--shadow)}
    .header-wrap{max-width:1200px;margin:auto;padding:14px 20px;display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:rgba(255,255,255,.18);display:flex;align-items:center;justify-content:center;font-size:20px}
    h1{font-size:1.25rem;margin:0;font-weight:700}
    .container{max-width:1200px;margin:auto;padding:20px}

    .tabs{display:flex;gap:2px;margin:18px 0;box-shadow:var(--shadow);border-radius:10px;overflow:hidden}
    .tab-btn{flex:1;padding:12px;border:0;background:#e9efff;color:#333;font-weight:600;cursor:pointer}
    .tab-btn.active{background:var(--primary);color:#fff}
    .tab{display:none}
    .tab.active{display:block}

    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);margin-bottom:20px}
    .card h3{margin:0;padding:14px 16px;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border-radius:12px 12px 0 0;font-size:1.05rem}
    .card-body{padding:18px}

    .row{display:flex;gap:16px;flex-wrap:wrap}
    .col{flex:1 1 280px}

    label{font-weight:600;display:block;margin:6px 0}
    input[type="text"], input[type="date"], select, textarea{
      width:100%;padding:10px;border:1px solid #cfd4dc;border-radius:10px;background:#fff
    }
    textarea{min-height:90px;resize:vertical}

    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer;background:#f8fafc}
    .chip.active{background:#e8f0fe;border-color:#cbd5ff}

    .actions{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .btn{border:0;border-radius:10px;padding:10px 16px;cursor:pointer;font-weight:700}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-light{background:#eef2ff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn-ghost{background:#f3f4f6}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:10px;vertical-align:top}
    th{background:var(--primary);color:#fff;text-align:left;position:sticky;top:0}
    tr:nth-child(even){background:#fafafa}

    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal.open{display:flex}
    .modal-card{background:#fff;border-radius:16px;box-shadow:var(--shadow);width:min(800px,96vw)}
    .modal-card h4{margin:0;padding:14px 16px;background:#111827;color:#fff;border-radius:16px 16px 0 0}
    .modal-body{padding:16px}
    .modal-actions{display:flex;justify-content:flex-end;gap:10px;padding:10px 16px;border-top:1px solid var(--border)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid #cbd5ff;font-size:.85rem}

    .hint{color:var(--muted);font-size:.9rem}
  </style>
</head>
<body>

<header>
  <div class="header-wrap">
    <div class="logo"><i class="fa-solid fa-graduation-cap"></i></div>
    <div>
      <h1>Registro de Ocorrências Escolares</h1>
      <div class="hint">Formulário, registros, estatísticas com gráficos em rosca 3D e exportações.</div>
    </div>
  </div>
</header>

<div class="container">

  <!-- Abas -->
  <div class="tabs">
    <button class="tab-btn active" data-tab="tab-form"><i class="fa-solid fa-pen-to-square"></i> Cadastrar</button>
    <button class="tab-btn" data-tab="tab-registros"><i class="fa-solid fa-table-list"></i> Registros</button>
    <button class="tab-btn" data-tab="tab-stats"><i class="fa-solid fa-chart-pie"></i> Estatísticas</button>
  </div>

  <!-- Tab: Formulário -->
  <section id="tab-form" class="tab active">
    <div class="card">
      <h3>Formulário de Ocorrência</h3>
      <div class="card-body">
        <form id="occForm">
          <div class="row">
            <div class="col">
              <label for="professor">Professor</label>
              <input id="professor" type="text" placeholder="Nome do professor(a)" required>
            </div>
            <div class="col">
              <label for="date">Data</label>
              <input id="date" type="date" required>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label for="studentClass">Turma</label>
              <select id="studentClass" required>
                <option value="">Selecione</option>
                <!-- FUNDAMENTAL 2 -->
                <optgroup label="6º ANO - MANHÃ">
                  <option>6° ANO A MANHA</option>
                  <option>6° ANO B MANHA</option>
                  <option>6° ANO C MANHA</option>
                  <option>6° ANO D MANHA</option>
                </optgroup>
                <optgroup label="6º ANO - TARDE">
                  <option>6° ANO A TARDE</option>
                  <option>6° ANO B TARDE</option>
                  <option>6° ANO C TARDE</option>
                  <option>6° ANO D TARDE</option>
                </optgroup>

                <optgroup label="7º ANO - MANHÃ">
                  <option>7° ANO A MANHA</option>
                  <option>7° ANO B MANHA</option>
                  <option>7° ANO C MANHA</option>
                  <option>7° ANO D MANHA</option>
                </optgroup>
                <optgroup label="7º ANO - TARDE">
                  <option>7° ANO A TARDE</option>
                  <option>7° ANO B TARDE</option>
                  <option>7° ANO C TARDE</option>
                  <option>7° ANO D TARDE</option>
                </optgroup>

                <optgroup label="8º ANO - MANHÃ">
                  <option>8° ANO A MANHA</option>
                  <option>8° ANO B MANHA</option>
                  <option>8° ANO C MANHA</option>
                  <option>8° ANO D MANHA</option>
                </optgroup>
                <optgroup label="8º ANO - TARDE">
                  <option>8° ANO A TARDE</option>
                  <option>8° ANO B TARDE</option>
                  <option>8° ANO C TARDE</option>
                  <option>8° ANO D TARDE</option>
                </optgroup>

                <optgroup label="9º ANO - MANHÃ">
                  <option>9° ANO A MANHA</option>
                  <option>9° ANO B MANHA</option>
                  <option>9° ANO C MANHA</option>
                  <option>9° ANO D MANHA</option>
                </optgroup>
                <optgroup label="9º ANO - TARDE">
                  <option>9° ANO A TARDE</option>
                  <option>9° ANO B TARDE</option>
                  <option>9° ANO C TARDE</option>
                  <option>9° ANO D TARDE</option>
                </optgroup>

                <!-- ENSINO MÉDIO -->
                <optgroup label="1ª SÉRIE - MANHÃ">
                  <option>1ª SERIE A MANHA</option>
                  <option>1ª SERIE B MANHA</option>
                  <option>1ª SERIE C MANHA</option>
                </optgroup>
                <optgroup label="1ª SÉRIE - TARDE">
                  <option>1ª SERIE A TARDE</option>
                  <option>1ª SERIE B TARDE</option>
                </optgroup>
                <optgroup label="1ª SÉRIE - NOITE">
                  <option>1ª SERIE A NOITE</option>
                  <option>1ª SERIE B NOITE</option>
                </optgroup>

                <optgroup label="2ª SÉRIE - MANHÃ">
                  <option>2ª SERIE A MANHA</option>
                  <option>2ª SERIE B MANHA</option>
                  <option>2ª SERIE C MANHA</option>
                </optgroup>
                <optgroup label="2ª SÉRIE - TARDE/NOITE">
                  <option>2ª SERIE A TARDE</option>
                  <option>2ª SERIE B TARDE</option>
                  <option>2ª SERIE A NOITE</option>
                </optgroup>

                <optgroup label="3ª SÉRIE - MANHÃ">
                  <option>3ª SERIE A MANHA</option>
                  <option>3ª SERIE B MANHA</option>
                </optgroup>
                <optgroup label="3ª SÉRIE - NOITE">
                  <option>3ª SERIE D NOITE</option>
                  <option>3ª SERIE E NOITE</option>
                  <option>3ª SERIE F NOITE</option>
                </optgroup>
              </select>
            </div>

            <div class="col">
              <label for="student">Aluno</label>
              <select id="student" required disabled>
                <option>Selecione a turma primeiro</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col">
              <label>Irregularidades <span class="hint">(clique para marcar; campo abaixo recebe sua seleção)</span></label>
              <div id="irregularitiesChips" class="chips"></div>
              <input id="irregularities" type="text" placeholder="Pode digitar manualmente; múltiplas separadas por vírgula">
            </div>
            <div class="col">
              <label for="description">Descrição</label>
              <textarea id="description" placeholder="Detalhe a ocorrência (o que aconteceu, local, aula, etc.)"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn btn-primary" type="submit"><i class="fa-solid fa-save"></i> Cadastrar</button>
            <button class="btn btn-ghost" type="button" id="clearBtn"><i class="fa-solid fa-eraser"></i> Limpar</button>
          </div>
          <div class="hint" style="margin-top:8px">
            Obs.: Se aparecer “Failed to fetch”, verifique o <b>Deploy do Apps Script (Web App)</b>, permissões “Anyone with the link” e se a URL em <code>API_URL</code> está correta.
          </div>
        </form>
      </div>
    </div>
  </section>

  <!-- Tab: Registros -->
  <section id="tab-registros" class="tab">
    <div class="card">
      <h3>Registros de Ocorrências</h3>
      <div class="card-body">
        <div class="toolbar">
          <button class="btn btn-light" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Atualizar</button>
          <button class="btn btn-light" id="excelBtn"><i class="fa-solid fa-file-excel"></i> Exportar Excel</button>
          <button class="btn btn-light" id="pdfBtn"><i class="fa-solid fa-file-pdf"></i> Exportar PDF</button>
          <span class="pill"><i class="fa-regular fa-circle"></i> <span id="counter">0</span> registros</span>
        </div>
        <div style="max-height:60vh;overflow:auto;border:1px solid var(--border);border-radius:10px">
          <table id="tbl">
            <thead>
              <tr>
                <th style="min-width:110px">Data</th>
                <th style="min-width:140px">Professor</th>
                <th style="min-width:160px">Turma</th>
                <th style="min-width:180px">Aluno</th>
                <th style="min-width:220px">Irregularidades</th>
                <th style="min-width:260px">Descrição</th>
                <th style="min-width:140px">Ações</th>
              </tr>
            </thead>
            <tbody id="registrosTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Tab: Estatísticas -->
  <section id="tab-stats" class="tab">
    <div class="card">
      <h3>Estatísticas e Gráficos</h3>
      <div class="card-body">
        <div class="row">
          <div class="col">
            <div id="donutIrregularities" style="height:360px"></div>
          </div>
          <div class="col">
            <div id="donutClasses" style="height:360px"></div>
          </div>
        </div>
        <div class="row" style="margin-top:16px">
          <div class="col">
            <div class="pill">Total: <b id="totalOccurrences">0</b></div>
            <div class="pill">Mais comum: <b id="mostFrequentIrregularity">-</b></div>
            <div class="pill">Turma mais afetada: <b id="mostAffectedClass">-</b></div>
          </div>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Modal Editar -->
<div id="editModal" class="modal" aria-hidden="true">
  <div class="modal-card">
    <h4>Editar Ocorrência</h4>
    <div class="modal-body">
      <form id="editForm">
        <input type="hidden" id="editId">
        <div class="row">
          <div class="col">
            <label>Professor</label>
            <input id="editProfessor" type="text" required>
          </div>
          <div class="col">
            <label>Data</label>
            <input id="editDate" type="date" required>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Turma</label>
            <select id="editClass" required></select>
          </div>
          <div class="col">
            <label>Aluno</label>
            <select id="editStudent" required disabled>
              <option>Selecione a turma primeiro</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label>Irregularidades</label>
            <input id="editIrregularities" type="text">
          </div>
          <div class="col">
            <label>Descrição</label>
            <textarea id="editDescription"></textarea>
          </div>
        </div>
      </form>
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" id="closeEdit">Cancelar</button>
      <button class="btn btn-primary" id="saveEdit"><i class="fa-solid fa-floppy-disk"></i> Salvar</button>
    </div>
  </div>
</div>

<script>
/* ==============================
   CONFIG
============================== */
const API_URL = "https://script.google.com/macros/s/AKfycbw1fLZBv_mG3ziOHrNacOa9OQt8694x1RnNMe52a7eQjmG2_vS5r6kzLdUdXO3P7AuK/exec"; // <-- troque aqui

// catálogo de irregularidades (para chips + sugestão)
const IRREG_LIST = [
  "Atraso", "Falta sem justificativa", "Uso de celular em aula", "Desrespeito ao professor",
  "Brincadeiras inadequadas", "Agressão verbal", "Agressão física", "Não trouxe material",
  "Tarefa não realizada", "Perturbação em sala", "Saída sem autorização",
  "Descumprimento de normas", "Uniforme inadequado", "Uso indevido de rede", "Comida/Bebida em sala"
];

/* ==============================
   TABS
============================== */
document.querySelectorAll(".tab-btn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    btn.classList.add("active");
    document.getElementById(btn.dataset.tab).classList.add("active");
    if(btn.dataset.tab==="tab-registros") loadRegistros();
    if(btn.dataset.tab==="tab-stats") refreshStatsAndCharts();
  });
});

/* ==============================
   FORM: Turma -> Alunos
============================== */
const selClass = document.getElementById("studentClass");
const selStudent = document.getElementById("student");
selClass.addEventListener("change", ()=> loadStudents(selClass.value, selStudent));

async function loadStudents(turma, selectEl){
  selectEl.innerHTML = "<option>Carregando...</option>";
  selectEl.disabled = true;
  if(!turma){ selectEl.innerHTML = "<option>Selecione a turma</option>"; return; }
  const res = await safeFetch(`${API_URL}?action=getStudents&class=${encodeURIComponent(turma)}`);
  if(!res) { selectEl.innerHTML = "<option>Erro ao carregar</option>"; return; }
  const data = await res.json();
  selectEl.innerHTML = "<option value=''>Selecione o aluno</option>";
  (data.students||[]).forEach(n=>{
    const opt=document.createElement("option"); opt.value=n; opt.textContent=n; selectEl.appendChild(opt);
  });
  selectEl.disabled = false;
}

/* ==============================
   FORM: Irregularidades (chips)
============================== */
const chipsWrap = document.getElementById("irregularitiesChips");
const irrInput = document.getElementById("irregularities");
IRREG_LIST.forEach(item=>{
  const c=document.createElement("button");
  c.type="button"; c.className="chip"; c.textContent=item;
  c.addEventListener("click",()=>{
    c.classList.toggle("active");
    const set = new Set((irrInput.value||"").split(",").map(s=>s.trim()).filter(Boolean));
    if(c.classList.contains("active")) set.add(item); else set.delete(item);
    irrInput.value = Array.from(set).join(", ");
  });
  chipsWrap.appendChild(c);
});

/* ==============================
   CADASTRAR
============================== */
document.getElementById("occForm").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const payload = {
    action:"addOccurrence",
    professor: val("professor"),
    date: val("date"),
    studentClass: val("studentClass"),
    student: val("student"),
    irregularities: val("irregularities"),
    description: val("description")
  };
  const ok = await postJSON(payload);
  if(ok){
    e.target.reset();
    selStudent.disabled = true;
    toast("Ocorrência cadastrada.", "ok");
    loadRegistros(); refreshStatsAndCharts();
  }
});

document.getElementById("clearBtn").addEventListener("click",()=>{
  document.getElementById("occForm").reset();
  selStudent.disabled = true;
});

/* ==============================
   REGISTROS: carregar, editar, excluir
============================== */
const tbody = document.getElementById("registrosTableBody");
const counter = document.getElementById("counter");

document.getElementById("refreshBtn").addEventListener("click", loadRegistros);

async function loadRegistros(){
  const res = await safeFetch(`${API_URL}?action=getAllOccurrences`);
  if(!res) return;
  const data = await res.json();
  const list = data.occurrences || [];
  counter.textContent = list.length.toString();
  tbody.innerHTML = "";
  list.forEach(o=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${escapeHtml(o.date||"")}</td>
      <td>${escapeHtml(o.professor||"")}</td>
      <td>${escapeHtml(o.class||"")}</td>
      <td>${escapeHtml(o.student||"")}</td>
      <td>${escapeHtml(o.irregularities||"")}</td>
      <td>${escapeHtml(o.description||"")}</td>
      <td>
        <button class="btn btn-light" data-act="edit" data-id="${o.id}"><i class="fa-solid fa-pen"></i></button>
        <button class="btn btn-danger" data-act="del" data-id="${o.id}"><i class="fa-solid fa-trash"></i></button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // ações
  tbody.querySelectorAll("button").forEach(b=>{
    const id=b.dataset.id, act=b.dataset.act;
    if(act==="edit") b.addEventListener("click", ()=> openEditModal(id));
    if(act==="del")  b.addEventListener("click", ()=> confirmDelete(id));
  });
}

/* ==============================
   EDIT MODAL
============================== */
const editModal = document.getElementById("editModal");
const editForm  = document.getElementById("editForm");
const closeEdit = document.getElementById("closeEdit");
const saveEdit  = document.getElementById("saveEdit");
const editClass = document.getElementById("editClass");
const editStudent = document.getElementById("editStudent");

function fillClassOptions(selectEl){
  // Reutiliza as mesmas opções do select principal
  selectEl.innerHTML = document.getElementById("studentClass").innerHTML;
}
fillClassOptions(editClass);

closeEdit.addEventListener("click", ()=> editModal.classList.remove("open"));

editClass.addEventListener("change", ()=> loadStudents(editClass.value, editStudent));

async function openEditModal(id){
  // busca por ID (seu GAS da Versão 2 implementa getOccurrenceById)
  const res = await safeFetch(`${API_URL}?action=getOccurrenceById&id=${encodeURIComponent(id)}`);
  if(!res){ toast("Erro ao abrir registro.", "err"); return; }
  const { occurrence } = await res.json();
  if(!occurrence){ toast("Registro não encontrado.", "err"); return; }

  document.getElementById("editId").value = occurrence.id;
  document.getElementById("editProfessor").value = occurrence.professor || "";
  document.getElementById("editDate").value = toInputDate(occurrence.date);
  editClass.value = occurrence.class || "";
  await loadStudents(editClass.value, editStudent);
  editStudent.value = occurrence.student || "";
  document.getElementById("editIrregularities").value = occurrence.irregularities || "";
  document.getElementById("editDescription").value = occurrence.description || "";

  editModal.classList.add("open");
}

saveEdit.addEventListener("click", async ()=>{
  const payload = {
    action:"updateOccurrence",
    id: val("editId"),
    professor: val("editProfessor"),
    date: val("editDate"),
    studentClass: val("editClass"),
    student: val("editStudent"),
    irregularities: val("editIrregularities"),
    description: val("editDescription")
  };
  const ok = await postJSON(payload);
  if(ok){
    toast("Registro atualizado.", "ok");
    editModal.classList.remove("open");
    loadRegistros(); refreshStatsAndCharts();
  }
});

async function confirmDelete(id){
  if(!confirm("Excluir este registro?")) return;
  const ok = await postJSON({ action:"deleteOccurrence", id });
  if(ok){
    toast("Registro excluído.", "ok");
    loadRegistros(); refreshStatsAndCharts();
  }
}

/* ==============================
   ESTATÍSTICAS + GRÁFICOS (ROSCA 3D)
============================== */
const totalEl = document.getElementById("totalOccurrences");
const mostIrrEl = document.getElementById("mostFrequentIrregularity");
const mostClassEl = document.getElementById("mostAffectedClass");

async function refreshStatsAndCharts(){
  // Traz registros e calcula distribuições no cliente p/ gráficos detalhados
  const res = await safeFetch(`${API_URL}?action=getAllOccurrences`);
  if(!res) return;
  const { occurrences=[] } = await res.json();

  // Totais simples
  totalEl.textContent = occurrences.length.toString();

  // Distribuição por irregularidade (conta cada item da lista separada por vírgula)
  const irrCount = {};
  const classCount = {};
  occurrences.forEach(o=>{
    (String(o.irregularities||"").split(",").map(s=>s.trim()).filter(Boolean)).forEach(i=>{
      irrCount[i] = (irrCount[i]||0)+1;
    });
    const c = o.class || "";
    classCount[c] = (classCount[c]||0)+1;
  });

  const topIrr = Object.entries(irrCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";
  const topClass = Object.entries(classCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || "-";
  mostIrrEl.textContent = topIrr;
  mostClassEl.textContent = topClass;

  // Monta séries para os donuts
  const irrSeries = Object.entries(irrCount).map(([name, y])=>({ name, y }));
  const classSeries = Object.entries(classCount).map(([name, y])=>({ name, y }));

  renderDonut3D("donutIrregularities", "Irregularidades (distribuição)", irrSeries);
  renderDonut3D("donutClasses", "Ocorrências por Turma", classSeries);
}

function renderDonut3D(containerId, title, seriesData){
  Highcharts.chart(containerId, {
    chart: {
      type: 'pie',
      backgroundColor: 'transparent',
      options3d: { enabled: true, alpha: 50, beta: 0 }
    },
    title: { text: title },
    tooltip: { pointFormat: '<b>{point.y}</b> ({point.percentage:.1f}%)' },
    plotOptions: {
      pie: {
        innerSize: 120, // rosca
        depth: 45,      // 3D
        allowPointSelect: true,
        dataLabels: { enabled: true, format: '{point.name}: {point.y}' }
      }
    },
    series: [{ name: 'Quantidade', data: seriesData }]
  });
}

/* ==============================
   EXPORTAÇÕES
============================== */
document.getElementById("excelBtn").addEventListener("click", exportExcel);
document.getElementById("pdfBtn").addEventListener("click", exportPDF);

async function exportExcel(){
  const res = await safeFetch(`${API_URL}?action=getAllOccurrences`);
  if(!res) return;
  const { occurrences=[] } = await res.json();
  const rows = [
    ["Data","Professor","Turma","Aluno","Irregularidades","Descrição","ID"]
  ];
  occurrences.forEach(o=>{
    rows.push([o.date||"", o.professor||"", o.class||"", o.student||"", o.irregularities||"", o.description||"", o.id||""]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "Ocorrencias");
  XLSX.writeFile(wb, "ocorrencias.xlsx");
}

async function exportPDF(){
  const res = await safeFetch(`${API_URL}?action=getAllOccurrences`);
  if(!res) return;
  const { occurrences=[] } = await res.json();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'landscape' });
  doc.setFontSize(14);
  doc.text("Ocorrências - Relatório", 14, 14);
  const body = occurrences.map(o=>[
    o.date||"", o.professor||"", o.class||"", o.student||"", o.irregularities||"", o.description||""
  ]);
  doc.autoTable({
    head:[["Data","Professor","Turma","Aluno","Irregularidades","Descrição"]],
    body,
    startY: 20,
    styles:{ fontSize:8, cellWidth:'wrap' },
    headStyles:{ fillColor:[26,115,232] }
  });
  doc.save("ocorrencias.pdf");
}

/* ==============================
   HELPERS
============================== */
function val(id){ return document.getElementById(id).value?.trim(); }
function toast(msg, type="ok"){
  const el=document.createElement("div");
  el.textContent=msg;
  el.style.cssText="position:fixed;right:16px;bottom:16px;padding:10px 14px;border-radius:10px;color:#fff;z-index:99;box-shadow:var(--shadow)";
  el.style.background = type==="ok" ? "var(--ok)" : (type==="err" ? "var(--danger)" : "var(--primary)");
  document.body.appendChild(el); setTimeout(()=> el.remove(), 2600);
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
function toInputDate(v){
  // aceita "2025-08-31" ou "31/08/2025"
  if(!v) return "";
  if(/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
  const m=v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
  if(m) return `${m[3]}-${m[2]}-${m[1]}`;
  // fallback: tenta Date
  const d=new Date(v); if(!isNaN(d)) return d.toISOString().slice(0,10);
  return "";
}
async function postJSON(payload){
  try{
    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if(!res.ok){ toast("Falha na API (POST).", "err"); return false; }
    const j = await res.json();
    if(j.status==="success" || j.success===true) return true;
    toast(j.message||"Erro na operação.", "err");
    return false;
  }catch(e){ console.error(e); toast("Failed to fetch (POST).", "err"); return false; }
}
async function safeFetch(url){
  try{
    const res = await fetch(url);
    if(!res.ok){ toast("Falha na API (GET).", "err"); return null; }
    return res;
  }catch(e){ console.error(e); toast("Failed to fetch (GET).", "err"); return null; }
}

/* ==============================
   INIT
============================== */
(function init(){
  // data padrão = hoje
  const today = new Date(); document.getElementById("date").value = today.toISOString().slice(0,10);
  // carrega primeira vez
  loadRegistros(); refreshStatsAndCharts();
})();
</script>
</body>
</html>
