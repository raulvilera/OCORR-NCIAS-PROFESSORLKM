<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorrências - 2025 (corrigido)</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* (Mantive layout visual parecido com seu original, compacto aqui para leitura) */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{font-family:Segoe UI, Roboto, Arial, sans-serif;background:#eef7ff;padding:20px;color:#222}
    .app{max-width:1100px;margin:0 auto;display:flex;flex-direction:column;gap:18px}
    header{display:flex;justify-content:space-between;align-items:center;padding:16px;background:#0e4b75;color:#fff;border-radius:10px}
    header h1{font-size:18px}
    .card{background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    select,input,textarea,button{font-size:14px}
    .form-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .field{flex:1;min-width:200px}
    label{display:block;margin-bottom:6px;font-weight:600;color:#2a4b7a}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #d6d6d6;background:#fff
    }
    .subtitle{font-weight:700;color:#0e4b75;margin-bottom:12px}
    .student-selector{padding:10px;border:1px solid #d6d6d6;border-radius:8px;background:#fafafa;cursor:pointer}
    .pill{display:inline-block;background:#2a6ab0;color:#fff;padding:6px 10px;border-radius:16px;margin:6px 6px 0 0;font-weight:600}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal{background:#fff;border-radius:8px;padding:16px;width:92%;max-width:680px;max-height:80vh;overflow:auto}
    .student-checkbox{display:flex;align-items:center;gap:10px;padding:8px;border-bottom:1px solid #eee}
    .loader{width:18px;height:18px;border:3px solid rgba(0,0,0,0.08);border-top-color:#2a6ab0;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .muted{color:#666}
    .actions{display:flex;gap:8px}
    button{padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
    .btn-primary{background:#2a6ab0;color:#fff}
    .btn-success{background:#2e8b3a;color:#fff}
    .btn-danger{background:#d32f2f;color:#fff}
    @media(max-width:900px){ .form-row{flex-direction:column} }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>2025 — Cadastro de Ocorrências (corrigido)</h1>
      <div id="userArea" class="muted">Não autenticado</div>
    </header>

    <!-- LOGIN SIMPLES -->
    <div id="loginCard" class="card">
      <div class="subtitle">Acesso</div>
      <div class="form-row">
        <div class="field">
          <label for="emailLogin">E-mail</label>
          <input id="emailLogin" type="email" placeholder="gestao@escola.com ou professor@escola.com">
        </div>
        <div class="field">
          <label for="passwordLogin">Senha</label>
          <input id="passwordLogin" type="password" placeholder="senha">
        </div>
      </div>
      <div class="actions">
        <button class="btn-primary" onclick="doLogin()">Entrar</button>
        <button class="btn-success" onclick="fillDemo()">Demo</button>
      </div>
    </div>

    <!-- ÁREA GESTÃO -->
    <div id="appGestao" style="display:none">
      <div class="card">
        <div class="subtitle">CADASTRO — GESTÃO</div>
        <div class="form-row">
          <div class="field">
            <label for="serie_gestao">Série / Turma</label>
            <select id="serie_gestao" onchange="onSerieGestaoChange(this.value)">
              <option value="">-- selecione --</option>
              <!-- As opções podem continuar como no original -->
            </select>
          </div>
          <div class="field">
            <label>Aluno(s)</label>
            <div class="student-selector" onclick="openModalGestao()">
              <span id="aluno_gestao_placeholder">Selecione a turma e depois clique para escolher os alunos</span>
            </div>
            <div id="selectedPillsGestao" style="margin-top:8px"></div>
          </div>
          <div class="field">
            <label>RA(s)</label>
            <input id="ra_gestao" type="text" readonly placeholder="RAs aparecerão ao confirmar seleção">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Professor</label>
            <input id="professor_gestao" type="text">
          </div>
          <div class="field">
            <label>Disciplina</label>
            <input id="disciplina_gestao" type="text">
          </div>
          <div class="field">
            <label>Classificação</label>
            <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
              <option value="">-- selecione --</option>
              <option value="OCORRÊNCIA">OCORRÊNCIA</option>
              <option value="SUSPENSÃO">SUSPENSÃO</option>
            </select>
          </div>
        </div>

        <div id="suspensionRow_gestao" class="form-row" style="display:none">
          <div class="field">
            <label>Data de retorno</label>
            <input id="dataRetorno_gestao" type="date">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Descrição</label>
            <textarea id="descricao_gestao" placeholder="Descrição..."></textarea>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
          <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF local</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO - GESTÃO</div>
          <button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button>
        </div>
        <div id="historyListGestao"></div>
      </div>
    </div>

    <!-- ÁREA PROFESSOR -->
    <div id="appProfessor" style="display:none">
      <div class="card">
        <div class="subtitle">REGISTRO — PROFESSOR</div>
        <div class="form-row">
          <div class="field">
            <label>Professor</label>
            <select id="professor_select"></select>
          </div>
          <div class="field">
            <label>Turma</label>
            <select id="turma_select" onchange="onTurmaChange()"></select>
          </div>
          <div class="field">
            <label>Data</label>
            <input id="data_prof" type="date">
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Alunos (clique para selecionar)</label>
            <div class="student-selector" onclick="openModalProfessor()">
              <span id="alunos_selected_placeholder">Clique para selecionar</span>
            </div>
            <div id="selectedPills" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Irregularidades</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px">
              <label><input type="checkbox" name="irreg" value="Agressão"> Agressão</label>
              <label><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
              <label><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
              <!-- demais opções -->
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="field">
            <label>Descrição</label>
            <textarea id="descricao_prof"></textarea>
          </div>
        </div>

        <div class="actions">
          <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
          <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO - PROFESSOR</div>
          <button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button>
        </div>
        <div id="historyListProfessor"></div>
      </div>
    </div>

    <!-- Modal Professor -->
    <div id="modalProfessor" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Selecionar alunos (Professor)</strong>
          <button onclick="closeModalProfessor()" style="background:transparent;border:0;font-size:18px">✕</button>
        </div>
        <input id="studentSearchProf" type="text" placeholder="Filtrar..." style="width:100%;padding:8px;margin-bottom:8px" oninput="filterStudentListProfessor()">
        <div id="studentListProf" style="max-height:46vh;overflow:auto"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn-primary" onclick="confirmStudentsProfessor()">Confirmar</button>
          <button class="btn-danger" onclick="closeModalProfessor()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Modal Gestao -->
    <div id="modalGestao" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <strong>Selecionar alunos (Gestão)</strong>
          <button onclick="closeModalGestao()" style="background:transparent;border:0;font-size:18px">✕</button>
        </div>
        <input id="studentSearchGest" type="text" placeholder="Filtrar..." style="width:100%;padding:8px;margin-bottom:8px" oninput="filterStudentListGestao()">
        <div id="studentListGest" style="max-height:46vh;overflow:auto"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button class="btn-primary" onclick="confirmStudentsGestao()">Confirmar</button>
          <button class="btn-danger" onclick="closeModalGestao()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>
    /********** CONFIG **********/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzKfbaaee6eUtKx_-awUpxA3VyEYriCzZJKw-WcZo7ZMl6pz9StmYfd-HOVIPzrJqz2/exec';
    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
    const SHEET_GESTAO = 'BANCODEALUNOS';

    // estado unificado/clareza
    let professores = [];
    let turmas = [];

    // Professor area
    let alunosDaTurmaProfessor = []; // array de {nome, ra}
    let alunosSelecionadosProfessor = []; // array de {nome, ra}

    // Gestao area
    let alunosDaTurmaGestao = []; // array de {nome, ra}
    let alunosSelecionadosGestao = []; // array de {nome, ra}

    let currentRole = null;

    document.addEventListener('DOMContentLoaded', () => {
      // data default
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      // popular opções de série/turma (use o mesmo conjunto que você tinha)
      populateSerieOptions();
    });

    function populateSerieOptions(){
      const selGest = document.getElementById('serie_gestao');
      const selTurma = document.getElementById('turma_select');
      // Use as mesmas options que você tinha; para simplicidade aqui, apenas adiciono algumas de exemplo.
      const options = [
        "6° ANO A MANHA","6° ANO B MANHA","7° ANO A TARDE","8° ANO A TARDE",
        "9° ANO A TARDE","1ª SERIE A MANHA","2ª SERIE A MANHA","3ª SERIE A MANHA"
      ];
      selGest.innerHTML = '<option value="">-- selecione --</option>';
      selTurma.innerHTML = '<option value="">-- selecione --</option>';
      options.forEach(o=>{
        const e1 = document.createElement('option'); e1.value = o; e1.textContent = o; selGest.appendChild(e1);
        const e2 = document.createElement('option'); e2.value = o; e2.textContent = o; selTurma.appendChild(e2);
      });
    }

    /********** LOGIN SIMPLES (demo) **********/
    function doLogin(){
      const email = document.getElementById('emailLogin').value.trim();
      const pass = document.getElementById('passwordLogin').value.trim();
      if(email === 'gestao@escola.com' && pass === 'gestao123'){
        openAsGestao(email);
      } else if(email === 'professor@escola.com' && pass === 'prof123'){
        openAsProfessor(email);
      } else {
        alert('Credenciais incorretas (use demo).');
      }
    }
    function fillDemo(){ document.getElementById('emailLogin').value='gestao@escola.com'; document.getElementById('passwordLogin').value='gestao123'; }

    async function openAsGestao(email){
      currentRole = 'gestao';
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('appGestao').style.display = 'block';
      document.getElementById('appProfessor').style.display = 'none';
      document.getElementById('userArea').textContent = email + ' (Gestão)';
      await carregarTodosProfessoresETurmas(); // popula professores/turmas para fallback
    }

    async function openAsProfessor(email){
      currentRole = 'professor';
      document.getElementById('loginCard').style.display = 'none';
      document.getElementById('appProfessor').style.display = 'block';
      document.getElementById('appGestao').style.display = 'none';
      document.getElementById('userArea').textContent = email + ' (Professor)';
      await carregarProfessoresETurmas();
    }

    /********** CARREGAR PROFESSORES E TURMAS (Professor area) **********/
    async function carregarProfessoresETurmas(){
      try {
        // teachers
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        professores = (j1 && j1.status === 'success' && Array.isArray(j1.teachers)) ? j1.teachers : [];
        // classes
        const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j2 = await r2.json();
        turmas = (j2 && j2.status === 'success' && Array.isArray(j2.classes)) ? j2.classes : [];
      } catch(e){
        console.warn('Erro ao buscar professores/turmas, usando fallback.', e);
        professores = ["PROF DEMO A","PROF DEMO B"];
        turmas = ["6° ANO A MANHA","7° ANO A TARDE"];
      }
      // popular selects
      const profSel = document.getElementById('professor_select'); profSel.innerHTML = '<option value="">-- selecione --</option>';
      professores.forEach(p => { const o = document.createElement('option'); o.value=p; o.textContent=p; profSel.appendChild(o); });
      const turmaSel = document.getElementById('turma_select'); turmaSel.innerHTML = '<option value="">-- selecione --</option>';
      turmas.forEach(t => { const o = document.createElement('option'); o.value=t; o.textContent=t; turmaSel.appendChild(o); });
    }

    // usada pela gestão no openAsGestao (carrega lista mínima)
    async function carregarTodosProfessoresETurmas(){
      await carregarProfessoresETurmas();
      // só para garantir que selects existam (gestão usa input text de professor)
    }

    /********** GET students by class - sempre retorna array de objetos {nome, ra} **********/
    async function fetchStudentsForClass(turma){
      if(!turma) return [];
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        // backend retorna students (names) e studentsList (objects). Preferimos studentsList quando disponível.
        if(json && json.status === 'success'){
          if(Array.isArray(json.studentsList) && json.studentsList.length > 0){
            // garantir formato {nome, ra}
            return json.studentsList.map(s => ({ nome: (s.nome||s.name||'').toString().trim(), ra: (s.ra||s.RA||'').toString().trim() }));
          } else if(Array.isArray(json.students)){
            // transformar array de nomes em objetos sem RA
            return json.students.filter(Boolean).map(n => ({ nome: String(n).trim(), ra: '' }));
          }
        }
      } catch(err){
        console.error('Erro ao buscar alunos:', err);
      }
      return [];
    }

    /********** PROFESSOR: evento ao mudar turma **********/
    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      alunosDaTurmaProfessor = [];
      alunosSelecionadosProfessor = [];
      document.getElementById('alunos_selected_placeholder').textContent = 'Clique para selecionar';
      document.getElementById('selectedPills').innerHTML = '';
      if(!turma) return;
      // opcional: mostrar loader
      document.getElementById('studentListProf').innerHTML = '<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando alunos...</div></div>';
      alunosDaTurmaProfessor = await fetchStudentsForClass(turma);
      // limpar lista de modal (se estiver aberto)
      renderStudentListProfessor(alunosDaTurmaProfessor);
    }

    /********** GESTÃO: evento ao mudar série/turma **********/
    async function onSerieGestaoChange(turma){
      alunosDaTurmaGestao = [];
      alunosSelecionadosGestao = [];
      document.getElementById('aluno_gestao_placeholder').textContent = 'Selecione a turma e depois clique para escolher os alunos';
      document.getElementById('selectedPillsGestao').innerHTML = '';
      document.getElementById('ra_gestao').value = '';
      if(!turma) return;
      document.getElementById('studentListGest').innerHTML = '<div style="display:flex;align-items:center;gap:8px"><div class="loader"></div><div class="muted">Carregando alunos...</div></div>';
      alunosDaTurmaGestao = await fetchStudentsForClass(turma);
      document.getElementById('aluno_gestao_placeholder').textContent = 'Clique para selecionar os alunos';
      // render apenas se modal aberto
      renderStudentListGestao(alunosDaTurmaGestao);
    }

    /********** MODAL PROFESSOR (abrir/fechar/render) **********/
    function openModalProfessor(){
      if(!alunosDaTurmaProfessor || alunosDaTurmaProfessor.length === 0){ alert('Selecione uma turma com alunos antes de abrir o seletor.'); return; }
      document.getElementById('studentSearchProf').value = '';
      renderStudentListProfessor(alunosDaTurmaProfessor);
      document.getElementById('modalProfessor').style.display = 'flex';
    }
    function closeModalProfessor(){ document.getElementById('modalProfessor').style.display = 'none'; }

    function renderStudentListProfessor(list){
      const container = document.getElementById('studentListProf'); container.innerHTML = '';
      if(!list || list.length === 0){ container.innerHTML = '<div class="muted">Nenhum aluno encontrado.</div>'; return; }
      list.forEach(s => {
        const row = document.createElement('div'); row.className='student-checkbox';
        const cb = document.createElement('input'); cb.type='checkbox';
        cb.checked = alunosSelecionadosProfessor.some(a => a.nome === s.nome);
        cb.onchange = (e) => {
          if(e.target.checked){
            if(!alunosSelecionadosProfessor.some(a => a.nome === s.nome)) alunosSelecionadosProfessor.push({ nome: s.nome, ra: s.ra || '' });
          } else {
            alunosSelecionadosProfessor = alunosSelecionadosProfessor.filter(a => a.nome !== s.nome);
          }
        };
        const lbl = document.createElement('div'); lbl.textContent = s.nome + (s.ra ? (' — RA: ' + s.ra) : '');
        row.appendChild(cb); row.appendChild(lbl);
        container.appendChild(row);
      });
    }

    function filterStudentListProfessor(){
      const q = document.getElementById('studentSearchProf').value.trim().toLowerCase();
      const filtered = alunosDaTurmaProfessor.filter(s => s.nome.toLowerCase().includes(q));
      renderStudentListProfessor(filtered);
    }

    function confirmStudentsProfessor(){
      // atualizar placeholder e pills
      document.getElementById('alunos_selected_placeholder').textContent = alunosSelecionadosProfessor.length > 0 ? `${alunosSelecionadosProfessor.length} aluno(s) selecionado(s)` : 'Clique para selecionar';
      const pills = document.getElementById('selectedPills'); pills.innerHTML = '';
      alunosSelecionadosProfessor.forEach(a => {
        const el = document.createElement('div'); el.className='pill'; el.textContent = a.nome;
        pills.appendChild(el);
      });
      // fechar modal
      closeModalProfessor();
    }

    /********** MODAL GESTÃO (abrir/fechar/render) **********/
    function openModalGestao(){
      const turma = document.getElementById('serie_gestao').value;
      if(!turma){ alert('Selecione uma turma primeiro.'); return; }
      if(!alunosDaTurmaGestao || alunosDaTurmaGestao.length === 0){ alert('Nenhum aluno encontrado para a turma selecionada.'); return; }
      document.getElementById('studentSearchGest').value = '';
      renderStudentListGestao(alunosDaTurmaGestao);
      document.getElementById('modalGestao').style.display = 'flex';
    }
    function closeModalGestao(){ document.getElementById('modalGestao').style.display = 'none'; }

    function renderStudentListGestao(list){
      const container = document.getElementById('studentListGest'); container.innerHTML = '';
      if(!list || list.length === 0){ container.innerHTML = '<div class="muted">Nenhum aluno encontrado.</div>'; return; }
      list.forEach(s => {
        const row = document.createElement('div'); row.className='student-checkbox';
        const cb = document.createElement('input'); cb.type='checkbox';
        cb.checked = alunosSelecionadosGestao.some(a => a.nome === s.nome);
        cb.onchange = (e) => {
          if(e.target.checked){
            if(!alunosSelecionadosGestao.some(a => a.nome === s.nome)) alunosSelecionadosGestao.push({ nome: s.nome, ra: s.ra || '' });
          } else {
            alunosSelecionadosGestao = alunosSelecionadosGestao.filter(a => a.nome !== s.nome);
          }
        };
        const lbl = document.createElement('div'); lbl.textContent = s.nome + (s.ra ? (' — RA: ' + s.ra) : '');
        row.appendChild(cb); row.appendChild(lbl);
        container.appendChild(row);
      });
    }

    function filterStudentListGestao(){
      const q = document.getElementById('studentSearchGest').value.trim().toLowerCase();
      const filtered = alunosDaTurmaGestao.filter(s => s.nome.toLowerCase().includes(q));
      renderStudentListGestao(filtered);
    }

    function confirmStudentsGestao(){
      document.getElementById('aluno_gestao_placeholder').textContent = alunosSelecionadosGestao.length > 0 ? `${alunosSelecionadosGestao.length} aluno(s) selecionado(s)` : 'Clique para selecionar os alunos';
      const pills = document.getElementById('selectedPillsGestao'); pills.innerHTML = '';
      alunosSelecionadosGestao.forEach(a => {
        const el = document.createElement('div'); el.className='pill'; el.textContent = a.nome;
        pills.appendChild(el);
      });
      // preencher RAs automaticamente (se houver)
      const ras = alunosSelecionadosGestao.map(a => a.ra).filter(r => r && r.length>0);
      document.getElementById('ra_gestao').value = ras.length > 0 ? ras.join(', ') : '';
      closeModalGestao();
    }

    /********** Toggle suspensão (gestao) **********/
    function toggleSuspension(area){
      if(area === 'gestao'){
        const val = document.getElementById('classificacao_gestao').value;
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENSÃO') ? 'block' : 'none';
      }
    }

    /********** POST: cadastrar ocorrência (gestão) **********/
    async function cadastrarOcorrenciaGestao(){
      const turma = document.getElementById('serie_gestao').value.trim();
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || null;
      if(!turma || alunosSelecionadosGestao.length === 0 || !professor || !disciplina || !classificacao || !descricao){
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      if(classificacao === 'SUSPENSÃO' && !dataRetorno){ alert('Informe data de retorno da suspensão.'); return; }

      const payload = {
        sheet: SHEET_GESTAO,
        startRow: 2,
        date: new Date().toISOString().split('T')[0],
        professor,
        studentClass: turma,
        student: alunosSelecionadosGestao.map(a=>a.nome).join(', '),
        ra: alunosSelecionadosGestao.map(a=>a.ra).filter(r=>r).join(', '),
        disciplina,
        irregularities: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
        description: descricao
      };

      try {
        const resp = await fetch(`${SCRIPT_URL}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j && j.status === 'success'){
          alert('Ocorrência (Gestão) registrada com sucesso.');
          // limpar form
          document.getElementById('serie_gestao').value = '';
          document.getElementById('aluno_gestao_placeholder').textContent = 'Selecione a turma e depois clique para escolher os alunos';
          document.getElementById('selectedPillsGestao').innerHTML = '';
          document.getElementById('ra_gestao').value = '';
          document.getElementById('professor_gestao').value = '';
          document.getElementById('disciplina_gestao').value = '';
          document.getElementById('classificacao_gestao').value = '';
          document.getElementById('descricao_gestao').value = '';
          document.getElementById('suspensionRow_gestao').style.display = 'none';
          alunosDaTurmaGestao = []; alunosSelecionadosGestao = [];
          carregarHistoricoGestao();
        } else {
          alert('Erro ao gravar (Gestão): ' + (j && j.message ? j.message : JSON.stringify(j)));
        }
      } catch(err){
        console.error('Erro POST Gestao:', err);
        alert('Erro ao comunicar com o servidor (ver console).');
      }
    }

    /********** POST: registrar ocorrência (professor) **********/
    async function registrarOcorrenciaProfessor(){
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();
      if(!professor || !turma || !dataOc || alunosSelecionadosProfessor.length === 0){
        alert('Preencha todos os campos obrigatórios e selecione ao menos um aluno.');
        return;
      }
      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);
      const payload = {
        sheet: SHEET_PROF,
        startRow: 2,
        date: dataOc,
        professor,
        studentClass: turma,
        student: alunosSelecionadosProfessor.map(a=>a.nome).join(', '),
        irregularities: irregs.join(', '),
        description: descricao
      };
      try {
        const resp = await fetch(`${SCRIPT_URL}`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j && j.status === 'success'){
          alert('Ocorrência (Professor) registrada com sucesso.');
          clearProfessorForm();
          carregarHistoricoProfessor();
        } else {
          alert('Erro ao gravar (Professor): ' + (j && j.message ? j.message : JSON.stringify(j)));
        }
      } catch(err){
        console.error('Erro POST Professor:', err);
        alert('Erro ao comunicar com o servidor (ver console).');
      }
    }

    function clearProfessorForm(){
      document.getElementById('professor_select').value=''; document.getElementById('turma_select').value='';
      document.getElementById('alunos_selected_placeholder').textContent = 'Clique para selecionar'; document.getElementById('selectedPills').innerHTML='';
      document.getElementById('descricao_prof').value=''; alunosSelecionadosProfessor = []; alunosDaTurmaProfessor = [];
      Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb=>cb.checked=false);
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
    }

    /********** HISTÓRICO (GET occurrences) **********/
    async function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div class="loader"></div><div class="muted">Carregando...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GESTAO)}`);
        const j = await resp.json();
        const ocorrs = (j && (j.occurrences || j.data)) || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }
        ocorrs.slice().reverse().forEach(r=>{
          const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
          div.innerHTML = `<div style="font-weight:700">${r.DATA||r.date||''} — ${r.PROFESSOR||r.professor||''}</div>
            <div class="muted" style="margin-top:6px"><strong>Aluno(s):</strong> ${r.ALUNO||r.student||''} — <strong>RA(s):</strong> ${r.RA||r.ra||''}</div>
            <div style="margin-top:6px">${r.DESCRICAO||r.description||''}</div>`;
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoGestao:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>';
      }
    }

    async function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><div class="loader"></div><div class="muted">Carregando...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_PROF)}`);
        const j = await resp.json();
        const ocorrs = (j && (j.occurrences || j.data)) || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length === 0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }
        ocorrs.slice().reverse().forEach(r=>{
          const div = document.createElement('div'); div.className='card'; div.style.marginBottom='8px';
          div.innerHTML = `<div style="font-weight:700">${r.DATA||r.date||''} — ${r.PROFESSOR||r.professor||''}</div>
            <div class="muted" style="margin-top:6px"><strong>Aluno(s):</strong> ${r.ALUNO||r.student||''}</div>
            <div style="margin-top:6px">${r.DESCRICAO||r.description||''}</div>`;
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoProfessor:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>';
      }
    }

    /********** Gerar PDF local (fallback) **********/
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14);
        doc.text('Registro de Ocorrência', 14, 20);
        doc.setFontSize(11);
        let y = 30;
        const turma = document.getElementById('serie_gestao').value || '';
        const alunos = alunosSelecionadosGestao.map(a=>a.nome).join(', ') || '';
        const ras = document.getElementById('ra_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const disciplina = document.getElementById('disciplina_gestao').value || '';
        const classificacao = document.getElementById('classificacao_gestao').value || '';
        doc.text(`Turma: ${turma}`, 14, y); y+=7;
        doc.text(`Aluno(s): ${alunos}`, 14, y); y+=7;
        doc.text(`RA(s): ${ras}`, 14, y); y+=7;
        doc.text(`Professor: ${prof}`, 14, y); y+=7;
        doc.text(`Disciplina: ${disciplina}`, 14, y); y+=7;
        doc.text(`Classificação: ${classificacao}`, 14, y); y+=10;
        const desc = document.getElementById('descricao_gestao').value || 'Sem descrição';
        const split = doc.splitTextToSize(desc, 180);
        doc.text(split, 14, y);
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){
        console.error('Erro gerar PDF local:', err); alert('Erro ao gerar PDF local (ver console).');
      }
    }

  </script>
</body>
</html>
