<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Ocorrências - 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* Estilos mantidos do código original */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #e6f2ff 0%, #e6ffe6 60%, #e6f9ff 100%);
      color:#333; font-weight:500; padding:20px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:20px}
    header{
      display:flex;align-items:center;justify-content:space-between;padding:20px;
      border-radius:12px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));
      box-shadow:0 8px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1);
    }
    header h1{font-size:22px;margin:0;color:#fff;}
    .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.1);border:1px solid #e0e0e0;}
    .flex-row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
    .flex-col{display:flex;flex-direction:column;gap:14px;}
    .form-section{background:#f0f0f0;padding:20px;border-radius:10px;margin-bottom:18px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.05);border:1px solid #d0d0d0}
    label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:#444;}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:14px;color:#333;background:#fff;
      transition:border-color .2s, box-shadow .2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    button{cursor:pointer;border:none;padding:12px 18px;border-radius:8px;font-weight:600;transition:all .2s}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .subtitle{font-size:18px;color:#2a5298;margin-bottom:14px;font-weight:600;padding-bottom:8px;border-bottom:2px solid #2a5298}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
    .historyItem{background:#f9f9f9;border-left:4px solid #2a5298;padding:18px;border-radius:8px;color:#333}
    .studentList{display:flex;flex-direction:column;gap:10px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 14px;border-radius:20px;font-weight:600;display:inline-block}
    .muted{opacity:.7;color:#666}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;padding:20px;border-radius:10px;max-height:84vh;overflow:auto}
    .student-checkbox{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid #eee}
    .login-options{display:flex;gap:12px}
    .login-option{flex:1;padding:14px;border-radius:8px;background:rgba(255,255,255,0.12);text-align:center;cursor:pointer}
    .login-option.active{background:linear-gradient(90deg,rgba(0,78,120,0.8),rgba(0,120,120,0.8));color:#fff}
    .success-message{display:none;margin-top:12px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff;font-weight:700}
    @media(max-width:980px){.flex-row{flex-direction:column}}
    .row{display:flex;gap:12px}
    .field{flex:1}
    .small{flex:0 0 220px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>2025 — Cadastro de Ocorrências</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userDisplay" class="muted">Não autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card">
      <div style="max-width:720px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>
        <div class="login-options" style="margin-bottom:16px">
          <div id="optionGestao" class="login-option active" onclick="selectLoginOption('gestao')">Acesso Gestão</div>
          <div id="optionProfessor" class="login-option" onclick="selectLoginOption('professor')">Acesso Professor</div>
        </div>

        <div id="loginFormGestao" class="access-area" style="display:block">
          <div class="form-section">
            <div class="row">
              <div class="field">
                <label for="emailGestao">E-mail Gestão</label>
                <input id="emailGestao" type="email" placeholder="gestao@escola.com">
              </div>
              <div class="field small">
                <label for="passwordGestao">Senha</label>
                <input id="passwordGestao" type="password" placeholder="senha">
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn-primary" onclick="login('gestao')">Entrar como Gestão</button>
              <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gestão</button>
            </div>
          </div>
        </div>

        <div id="loginFormProfessor" class="access-area" style="display:none">
          <div class="form-section">
            <div class="row">
              <div class="field">
                <label for="emailProfessor">E-mail Professor</label>
                <input id="emailProfessor" type="email" placeholder="professor@escola.com">
              </div>
              <div class="field small">
                <label for="passwordProfessor">Senha</label>
                <input id="passwordProfessor" type="password" placeholder="senha">
              </div>
            </div>
            <div style="margin-top:12px">
              <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:16px">
      <div class="card">
        <div class="subtitle">CADASTRO — GESTÃO</div>
        <div class="form-section">
          <div class="row">
            <div class="field">
              <label>Série / Turma</label>
              <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                <option value="">Selecione a turma</option>
              </select>
            </div>
            <div class="field">
              <label>Aluno(s)</label>
              <div class="student-selector" onclick="openStudentsModalGestao()">
                <span id="aluno_gestao_placeholder">Selecione a turma e depois clique para escolher os alunos</span>
              </div>
              <div id="selectedPillsGestao" style="margin-top:10px"></div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>RA(s)</label>
              <input id="ra_gestao" type="text" readonly placeholder="RAs aparecerão aqui">
            </div>
            <div class="field">
              <label>Professor</label>
              <input id="professor_gestao" type="text">
            </div>
            <div class="field">
              <label>Disciplina</label>
              <input id="disciplina_gestao" type="text">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Classificação</label>
              <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                <option value="">Selecione</option>
                <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                <option value="SUSPENSÃO">SUSPENSÃO</option>
              </select>
            </div>
            <div class="field" id="suspensionRow_gestao" style="display:none">
              <label>Data de retorno</label>
              <input id="dataRetorno_gestao" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Descrição</label>
            <textarea id="descricao_gestao" placeholder="Descrição detalhada"></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
            <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
          </div>

          <div id="successGestao" class="success-message">Ocorrência registrada com sucesso!</div>
        </div>
      </div>

      <!-- HISTÓRICO GESTÃO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
          <div><button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button></div>
        </div>
        <div id="historyListGestao" class="historyList"></div>
      </div>
    </div>

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:16px">
      <div class="card">
        <div class="subtitle">REGISTRO — PROFESSOR</div>
        <div class="form-section">
          <div class="row">
            <div class="field">
              <label>Professor</label>
              <select id="professor_select"></select>
            </div>
            <div class="field">
              <label>Turma</label>
              <select id="turma_select" onchange="onTurmaChange()"></select>
            </div>
            <div class="field small">
              <label>Data</label>
              <input id="data_prof" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Alunos (clique para selecionar)</label>
            <div class="student-selector" onclick="openStudentsModal()">
              <span id="alunos_selected_placeholder">Clique para selecionar</span>
            </div>
            <div id="selectedPills" style="margin-top:10px"></div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="field">
              <label>RA(s)</label>
              <input id="ra_prof" type="text" readonly placeholder="RAs aparecerão aqui">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Irregularidades</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
              <label><input type="checkbox" name="irreg" value="Agressão"> Agressão</label>
              <label><input type="checkbox" name="irreg" value="Danos ao patrimônio"> Danos ao patrimônio</label>
              <label><input type="checkbox" name="irreg" value="Desacato"> Desacato</label>
              <label><input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala</label>
              <label><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
              <label><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
              <label><input type="checkbox" name="irreg" value="Não realiza as atividades"> Não realiza as atividades</label>
              <label><input type="checkbox" name="irreg" value="Saiu da sala sem autorização"> Saiu da sala sem autorização</label>
              <label><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Descrição</label>
            <textarea id="descricao_prof" placeholder="Descreva a ocorrência..."></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
            <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
          </div>

          <div id="successProfessor" class="success-message">Ocorrência registrada com sucesso!</div>
        </div>
      </div>

      <!-- HISTÓRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
          <div><button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button></div>
        </div>
        <div id="historyListProfessor" class="historyList"></div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS PROFESSOR -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Selecionar alunos (Professor)</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
        </div>
        <div style="margin-bottom:12px">
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" oninput="filterStudentList()">
        </div>
        <div id="studentList" class="studentList"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS GESTÃO -->
    <div id="modalRootGestao" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Selecionar alunos (Gestão)</strong>
          <button onclick="closeStudentsModalGestao()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
        </div>
        <div style="margin-bottom:12px">
          <input id="studentSearchGestao" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" oninput="filterStudentListGestao()">
        </div>
        <div id="studentListGestao" class="studentList"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudentsGestao()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModalGestao()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /*******************************
     * CONFIGURAÇÕES
     *******************************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyepY4Hw-ABC-akVr0UPoTkyVluUqBc_vWrwdnGxqv3R3P_h5aKsKYbRtCP1Jveep9G/exec';
    const SPREADSHEET_ID = '1u7qMsMHkZT47OZdar5qvshQDRA8XJrLgDjAZVOViAio';

    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
    const SHEET_GESTAO = 'BANCODEALUNOS';

    // Mapeamento de turmas (frontend) - mantido conforme solicitado
    const CLASS_RANGES = {
      "6° ANO A MANHA":   { nome: "C3:C46",  ra: "D3:D46" },
      "6° ANO B MANHA":   { nome: "H3:H46",  ra: "I3:I46" },
      "6° ANO C MANHA":   { nome: "M3:M46",  ra: "N3:N46" },
      "6° ANO D MANHA":   { nome: "R3:R46",  ra: "S3:S46" },
      "6° ANO E TARDE":   { nome: "W3:W46",  ra: "X3:X46" },
      "6° ANO F TARDE":   { nome: "AB3:AB46", ra: "AC3:AC46" },
      "7° ANO A TARDE":   { nome: "AG3:AG46", ra: "AH3:AH46" },
      "7° ANO B TARDE":   { nome: "AL3:AL46", ra: "AM3:AM46" },
      "7° ANO C TARDE":   { nome: "AQ3:AQ46", ra: "AR3:AR46" },
      "7° ANO D TARDE":   { nome: "AV3:AV46", ra: "AW3:AW46" },
      "7° ANO E TARDE":   { nome: "BA3:BA46", ra: "BB3:BB46" },
      "7° ANO F TARDE":   { nome: "BF3:BF46", ra: "BG3:BG46" },
      "8° ANO A TARDE":   { nome: "BK3:BK46", ra: "BL3:BL46" },
      "8° ANO B TARDE":   { nome: "BP3:BP46", ra: "BQ3:BQ46" },
      "8° ANO C TARDE":   { nome: "BU3:BU46", ra: "BV3:BV46" },
      "8° ANO D TARDE":   { nome: "BZ3:BZ46", ra: "CA3:CA46" },
      "8° ANO E TARDE":   { nome: "CE3:CE46", ra: "CF3:CF46" },
      "9° ANO A TARDE":   { nome: "CJ3:CJ46", ra: "CK3:CK46" },
      "9° ANO B TARDE":   { nome: "CO3:CO46", ra: "CP3:CP46" },
      "9° ANO C TARDE":   { nome: "CT3:CT46", ra: "CU3:CU46" },
      "9° ANO D TARDE":   { nome: "CY3:CY46", ra: "CZ3:CZ46" },
      "1ª SERIE A MANHA": { nome: "DD3:DD46", ra: "DE3:DE46" },
      "1ª SERIE B MANHA": { nome: "DI3:DI46", ra: "DJ3:DJ46" },
      "1ª SERIE C MANHA": { nome: "DN3:DN46", ra: "DO3:DO46" },
      "1ª SERIE D MANHA": { nome: "DS3:DS46", ra: "DT3:DT46" },
      "1ª SERIE E MANHA": { nome: "DX3:DX46", ra: "DY3:DY46" },
      "1ª SERIE F MANHA": { nome: "EC3:EC46", ra: "ED3:ED46" },
      "1ª SERIE G TARDE": { nome: "EH3:EH46", ra: "EI3:EI46" },
      "1ª SERIE H NOITE": { nome: "EM3:EM46", ra: "EN3:EN46" },
      "1ª SERIE I NOITE": { nome: "ER3:ER46", ra: "ES3:ES46" },
      "2ª SERIE A MANHA": { nome: "EW3:EW46", ra: "EX3:EX46" },
      "2ª SERIE B MANHA": { nome: "FB3:FB46", ra: "FC3:FC46" }, 
      "2ª SERIE C MANHA": { nome: "FG3:FG46", ra: "FH3:FH46" },
      "2ª SERIE D MANHA": { nome: "FL3:FL46", ra: "FM3:FM46" },
      "2ª SERIE E MANHA": { nome: "FQ3:FQ46", ra: "FR3:FR46" },
      "2ª SERIE F NOITE": { nome: "FV3:FV46", ra: "FW3:FW46" },
      "2ª SERIE G NOITE": { nome: "GA3:GA46", ra: "GB3:GB46" },
      "2ª SERIE H NOITE": { nome: "GK3:GK46", ra: "GL3:GL46" },
      "3ª SERIE A MANHA": { nome: "GP3:GP46", ra: "GQ3:GQ46" },
      "3ª SERIE B MANHA": { nome: "GU3:GU46", ra: "GV3:GV46" },
      "3ª SERIE C MANHA": { nome: "GZ3:GZ46", ra: "HA3:HA46" },
      "3ª SERIE D NOITE": { nome: "HE3:HE46", ra: "HF3:HF46" },
      "3ª SERIE E NOITE": { nome: "HJ3:HJ46", ra: "HK3:HK46" },
      "3ª SERIE F NOITE": { nome: "HO3:HO46", ra: "HP3:HP46" },
      "3ª SERIE G NOITE": { nome: "HT3:HT46", ra: "HU3:HU46" }
    };

    // estado
    let alunosDaTurmaAtual = [];               // array de objetos { nome, ra }
    let alunosSelecionados = [];               // array de objetos { nome, ra }
    let alunosDaTurmaAtualGestao = [];
    let alunosSelecionadosGestao = [];
    let professores = [];
    let turmas = Object.keys(CLASS_RANGES);    // Usamos as chaves do mapeamento

    // inicialização
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
      selectLoginOption('gestao');
      populateTurmaOptions(); // Popula as opções de turma usando o mapeamento local
    });

    function selectLoginOption(role){
      document.querySelectorAll('.login-option').forEach(el=>el.classList.remove('active'));
      document.getElementById('option' + (role==='gestao' ? 'Gestao' : 'Professor')).classList.add('active');
      document.querySelectorAll('.access-area').forEach(a=>a.style.display='none');
      document.getElementById('loginForm' + (role==='gestao' ? 'Gestao' : 'Professor')).style.display = 'block';
    }

    function login(role){
      let email, pass;
      if(role==='gestao'){ email = document.getElementById('emailGestao').value.trim(); pass = document.getElementById('passwordGestao').value.trim(); }
      else { email = document.getElementById('emailProfessor').value.trim(); pass = document.getElementById('passwordProfessor').value.trim(); }
      if((role==='gestao' && email==='gestao@escola.com' && pass==='gestao123') || (role==='professor' && email==='professor@escola.com' && pass==='prof123')){
        showAppAs(role, email);
      } else alert('E-mail ou senha incorretos.');
    }
    function fillDemo(role){ if(role==='gestao'){ document.getElementById('emailGestao').value='gestao@escola.com'; document.getElementById('passwordGestao').value='gestao123'; } }

    function showAppAs(role, email){
      document.getElementById('loginScreen').style.display = 'none';
      if(role==='gestao'){
        document.getElementById('mainAppGestao').style.display = 'flex';
        document.getElementById('mainAppProfessor').style.display = 'none';
        carregarTodosSelects(); // carrega turmas para gestor, e alunos em background
        carregarHistoricoGestao();
      } else {
        document.getElementById('mainAppGestao').style.display = 'none';
        document.getElementById('mainAppProfessor').style.display = 'flex';
        carregarProfessoresETurmas();
        carregarHistoricoProfessor();
      }
      document.getElementById('userDisplay').textContent = email + (role==='gestao'?' (Gestão)':' (Professor)');
      document.getElementById('btnLogout').style.display = 'inline-block';
      document.getElementById('btnDownloadPdf').style.display = 'inline-block';
    }

    function logout(){
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('mainAppGestao').style.display = 'none';
      document.getElementById('mainAppProfessor').style.display = 'none';
      document.getElementById('userDisplay').textContent = 'Não autenticado';
      document.getElementById('btnLogout').style.display = 'none';
      document.getElementById('btnDownloadPdf').style.display = 'none';
      alunosDaTurmaAtual = []; alunosSelecionados = []; alunosDaTurmaAtualGestao = []; alunosSelecionadosGestao = [];
      document.getElementById('selectedPills').innerHTML=''; document.getElementById('selectedPillsGestao').innerHTML='';
      document.getElementById('alunos_selected_placeholder').textContent = 'Clique para selecionar';
      document.getElementById('aluno_gestao_placeholder').textContent = 'Selecione a turma e depois clique para escolher os alunos';
      document.getElementById('ra_prof').value=''; document.getElementById('ra_gestao').value='';
    }

    /* -------------------------
      Popula as opções de turma usando o mapeamento local
      ------------------------- */
    function populateTurmaOptions(){
      const selG = document.getElementById('serie_gestao');
      const selP = document.getElementById('turma_select');
      selG.innerHTML = '<option value="">Selecione a turma</option>';
      selP.innerHTML = '<option value="">-- selecione --</option>';
      
      turmas.forEach(t=>{
        const o1 = document.createElement('option'); o1.value=t; o1.textContent=t; selG.appendChild(o1);
        const o2 = document.createElement('option'); o2.value=t; o2.textContent=t; selP.appendChild(o2);
      });
    }

    /* -------------------------
      Carregar professores e turmas (professor)
      ------------------------- */
    async function carregarProfessoresETurmas(){
      try {
        // teachers
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) professores = j1.teachers;
        else professores = getFallbackProfessores();

        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => { const o = document.createElement('option'); o.value=p; o.textContent=p; profSel.appendChild(o) });
      } catch(err){
        console.error('Erro carregar professores:', err);
      }
    }

    /* -------------------------
      Carregar todos (usado por gestor para popular eventual autocomplete)
      ------------------------- */
    async function carregarTodosSelects(){
      // carrega professores também
      try {
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) professores = j1.teachers;
        else professores = getFallbackProfessores();
      } catch(err){
        console.error('Erro carregar professores (gestão):', err);
      }
    }

    /* -------------------------
      Carregar alunos por turma (PROF)
      ------------------------- */
    async function onTurmaChange(){
      const turma = document.getElementById('turma_select').value;
      if(!turma){ alunosDaTurmaAtual = []; renderStudentList([]); return; }
      await carregarAlunosPorTurma(turma);
      renderStudentList(alunosDaTurmaAtual);
    }

    async function carregarAlunosPorTurma(turma){
      alunosDaTurmaAtual = [];
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        // prefer studentsList (objetos)
        if(json && Array.isArray(json.studentsList) && json.studentsList.length){
          alunosDaTurmaAtual = json.studentsList.map(s => ({ nome: s.nome || (s.nome===0? '0':'') , ra: s.ra || '' }));
        } else if(json && Array.isArray(json.students) && json.students.length){
          alunosDaTurmaAtual = json.students.map(n => ({ nome: n, ra: '' }));
        } else {
          alunosDaTurmaAtual = [];
        }
      } catch(err){
        console.error('Erro get students:', err);
        alunosDaTurmaAtual = [];
      }
    }

    /* -------------------------
      Carregar alunos por turma (GESTÃO) - igual ao professor
      ------------------------- */
    async function carregarAlunosPorTurmaGestao(turma){
      if(!turma){ 
         alunosDaTurmaAtualGestao = []; 
         document.getElementById('aluno_gestao_placeholder').textContent = "Selecione a turma e depois clique para escolher os alunos";
         return; 
      }
      alunosDaTurmaAtualGestao = [];
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=students&sheet=${encodeURIComponent(SHEET_GERAL)}&turma=${encodeURIComponent(turma)}`);
        const json = await resp.json();
        if(json && Array.isArray(json.studentsList) && json.studentsList.length){
          alunosDaTurmaAtualGestao = json.studentsList.map(s=>({ nome: s.nome || '', ra: s.ra || '' }));
        } else if(json && Array.isArray(json.students) && json.students.length){
          alunosDaTurmaAtualGestao = json.students.map(n=>({ nome:n, ra:'' }));
        } else alunosDaTurmaAtualGestao = [];
        document.getElementById('aluno_gestao_placeholder').textContent = alunosDaTurmaAtualGestao.length ? 'Clique para selecionar os alunos' : 'Nenhum aluno nessa turma';
      } catch(err){
        console.error('Erro get students (gestão):', err);
        alunosDaTurmaAtualGestao = [];
      }
    }

    /* -------------------------
      Modal / Render - PROFESSOR
      - renderStudentList aceita lista de objetos {nome, ra}
      ------------------------- */
    function openStudentsModal(){
      if(!alunosDaTurmaAtual || alunosDaTurmaAtual.length === 0){ 
        alert('Nenhum aluno encontrado para a turma selecionada.'); 
        return; 
      }
      document.getElementById('modalRoot').style.display = 'flex';
      document.getElementById('studentSearch').value = '';
      renderStudentList(alunosDaTurmaAtual);
    }
    function closeStudentsModal(){ document.getElementById('modalRoot').style.display = 'none'; }

    function renderStudentList(list){
      const container = document.getElementById('studentList'); container.innerHTML = '';
      list.forEach((st, idx) => {
        const nome = st.nome || '';
        const ra = st.ra || '';
        const row = document.createElement('div'); row.className='student-checkbox';
        const cb = document.createElement('input'); cb.type='checkbox';
        // checkbox value is JSON string of the student object to avoid name collisions
        cb.value = JSON.stringify({nome, ra});
        // check if already selected
        cb.checked = alunosSelecionados.some(a => a.nome === nome && a.ra === ra);
        cb.onchange = (e) => {
          const obj = {nome, ra};
          if(e.target.checked){
            if(!alunosSelecionados.some(a => a.nome === obj.nome && a.ra === obj.ra)) alunosSelecionados.push(obj);
          } else {
            alunosSelecionados = alunosSelecionados.filter(a => !(a.nome === obj.nome && a.ra === obj.ra));
          }
        };
        const label = document.createElement('div'); label.style.flex='1';
        label.innerHTML = `<strong>${nome}</strong> ${ra?`<span style="color:#666;margin-left:8px">RA: ${ra}</span>`:''}`;
        row.appendChild(cb); row.appendChild(label);
        container.appendChild(row);
      });
    }

    function filterStudentList(){
      const q = document.getElementById('studentSearch').value.trim().toLowerCase();
      const filtered = alunosDaTurmaAtual.filter(s => (s.nome || '').toLowerCase().includes(q) || (s.ra||'').toLowerCase().includes(q));
      renderStudentList(filtered);
    }

    function confirmStudents(){
      document.getElementById('alunos_selected_placeholder').textContent = alunosSelecionados.length > 0 ? `${alunosSelecionados.length} aluno(s) selecionado(s)` : 'Clique para selecionar';
      const pills = document.getElementById('selectedPills');
      pills.innerHTML = '';
      alunosSelecionados.forEach(a=>{
        const el = document.createElement('div'); el.className='pill'; el.textContent = a.nome + (a.ra ? ` (${a.ra})` : '');
        pills.appendChild(el);
      });
      // preencher RAs no campo do professor (concat)
      document.getElementById('ra_prof').value = alunosSelecionados.map(a=>a.ra || '').filter(x=>x).join(', ');
      closeStudentsModal();
    }

    /* -------------------------
      Modal / Render - GESTÃO
      ------------------------- */
    function openStudentsModalGestao(){
      const turma = document.getElementById('serie_gestao').value;
      if(!turma){ alert('Selecione uma turma primeiro.'); return; }
      if(!alunosDaTurmaAtualGestao || alunosDaTurmaAtualGestao.length === 0){ 
        alert('Nenhum aluno encontrado para a turma selecionada.'); 
        return; 
      }
      document.getElementById('modalRootGestao').style.display = 'flex';
      document.getElementById('studentSearchGestao').value = '';
      renderStudentListGestao(alunosDaTurmaAtualGestao);
    }
    function closeStudentsModalGestao(){ document.getElementById('modalRootGestao').style.display = 'none'; }

    function renderStudentListGestao(list){
      const container = document.getElementById('studentListGestao'); container.innerHTML = '';
      list.forEach(st=>{
        const nome = st.nome || '';
        const ra = st.ra || '';
        const row = document.createElement('div'); row.className='student-checkbox';
        const cb = document.createElement('input'); cb.type='checkbox';
        cb.value = JSON.stringify({nome, ra});
        cb.checked = alunosSelecionadosGestao.some(a => a.nome === nome && a.ra === ra);
        cb.onchange = (e) => {
          const obj = {nome, ra};
          if(e.target.checked){
            if(!alunosSelecionadosGestao.some(a => a.nome === obj.nome && a.ra === obj.ra)) alunosSelecionadosGestao.push(obj);
          } else {
            alunosSelecionadosGestao = alunosSelecionadosGestao.filter(a => !(a.nome === obj.nome && a.ra === obj.ra));
          }
        };
        const label = document.createElement('div'); label.style.flex='1';
        label.innerHTML = `<strong>${nome}</strong> ${ra?`<span style="color:#666;margin-left:8px">RA: ${ra}</span>`:''}`;
        row.appendChild(cb); row.appendChild(label); container.appendChild(row);
      });
    }

    function filterStudentListGestao(){
      const q = document.getElementById('studentSearchGestao').value.trim().toLowerCase();
      const filtered = alunosDaTurmaAtualGestao.filter(s => (s.nome||'').toLowerCase().includes(q) || (s.ra||'').toLowerCase().includes(q));
      renderStudentListGestao(filtered);
    }

    function confirmStudentsGestao(){
      document.getElementById('aluno_gestao_placeholder').textContent = alunosSelecionadosGestao.length > 0 ? `${alunosSelecionadosGestao.length} aluno(s) selecionado(s)` : 'Clique para selecionar os alunos';
      const pills = document.getElementById('selectedPillsGestao'); pills.innerHTML = '';
      alunosSelecionadosGestao.forEach(a=>{
        const el = document.createElement('div'); el.className='pill'; el.textContent = a.nome + (a.ra?` (${a.ra})`:''); pills.appendChild(el);
      });
      // preencher automaticamente os RAs no campo da gestão
      document.getElementById('ra_gestao').value = alunosSelecionadosGestao.map(a=>a.ra || '').filter(x=>x).join(', ');
      closeStudentsModalGestao();
    }

    /* -------------------------
      Toggle suspensão
      ------------------------- */
    function toggleSuspension(area){
      if(area === 'gestao'){
        const val = document.getElementById('classificacao_gestao').value;
        document.getElementById('suspensionRow_gestao').style.display = (val === 'SUSPENSÃO') ? 'flex' : 'none';
      }
    }

    /* -------------------------
      POST cadastrar (GESTÃO)
      envia student: nomes, ra: RAs
      ------------------------- */
    async function cadastrarOcorrenciaGestao(){
      const turma = document.getElementById('serie_gestao').value.trim();
      const alunos = alunosSelecionadosGestao.map(a=>a.nome).join(', ');
      const ras = document.getElementById('ra_gestao').value.trim();
      const professor = document.getElementById('professor_gestao').value.trim();
      const disciplina = document.getElementById('disciplina_gestao').value.trim();
      const classificacao = document.getElementById('classificacao_gestao').value;
      const descricao = document.getElementById('descricao_gestao').value.trim();
      const dataRetorno = document.getElementById('dataRetorno_gestao').value || null;

      if(!turma || alunosSelecionadosGestao.length === 0 || !professor || !disciplina || !classificacao || !descricao){
        alert('Preencha todos os campos obrigatórios.');
        return;
      }
      if(classificacao === 'SUSPENSÃO' && !dataRetorno){ alert('Informe data de retorno para suspensão.'); return; }

      const payload = {
        sheet: SHEET_GESTAO,
        startRow: 2,
        date: new Date().toISOString().split('T')[0],
        professor: professor,
        studentClass: turma,
        student: alunos,
        ra: ras,
        disciplina: disciplina,
        irregularities: classificacao + (dataRetorno ? (' - retorno: ' + dataRetorno) : ''),
        description: descricao
      };

      try {
        const resp = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j && j.status === 'success'){
          document.getElementById('successGestao').style.display = 'block';
          setTimeout(()=> document.getElementById('successGestao').style.display = 'none', 2200);
          // limpar
          document.getElementById('serie_gestao').value=''; alunosSelecionadosGestao = []; document.getElementById('selectedPillsGestao').innerHTML='';
          document.getElementById('aluno_gestao_placeholder').textContent = "Selecione a turma e depois clique para escolher os alunos";
          document.getElementById('ra_gestao').value=''; document.getElementById('professor_gestao').value=''; document.getElementById('disciplina_gestao').value=''; document.getElementById('classificacao_gestao').value=''; document.getElementById('descricao_gestao').value=''; document.getElementById('suspensionRow_gestao').style.display='none';
          carregarHistoricoGestao();
        } else {
          alert('Erro ao registrar: ' + (j && j.message ? j.message : 'Resposta inesperada'));
        }
      } catch(err){
        console.error('Erro POST ocorrencia (gestao):', err);
        alert('Erro ao comunicar com o servidor (ver console).');
      }
    }

    /* -------------------------
      POST registrar ocorrência (PROFESSOR)
      - envia student: nomes (ou nomes com RA), ra: RAs
      ------------------------- */
    async function registrarOcorrenciaProfessor(){
      const professor = document.getElementById('professor_select').value;
      const turma = document.getElementById('turma_select').value;
      const dataOc = document.getElementById('data_prof').value;
      const descricao = document.getElementById('descricao_prof').value.trim();
      if(!professor || !turma || !dataOc || alunosSelecionados.length === 0){ alert('Preencha todos os campos obrigatórios e selecione ao menos um aluno.'); return; }

      const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);

      // montamos studentNames com RA incluído (por segurança)
      const studentNamesWithRA = alunosSelecionados.map(a => a.ra ? `${a.nome} (${a.ra})` : a.nome).join(', ');
      const ras = alunosSelecionados.map(a => a.ra || '').filter(x=>x).join(', ');

      const payload = {
        sheet: SHEET_PROF,
        startRow: 2,
        date: dataOc,
        professor: professor,
        studentClass: turma,
        student: studentNamesWithRA,
        ra: ras,
        irregularities: irregs.join(', '),
        description: descricao
      };

      try {
        const resp = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j && j.status === 'success'){
          document.getElementById('successProfessor').style.display = 'block';
          setTimeout(()=> document.getElementById('successProfessor').style.display = 'none', 2200);
          clearProfessorForm();
          carregarHistoricoProfessor();
        } else {
          alert('Erro ao registrar: ' + (j && j.message ? j.message : 'Resposta inesperada'));
        }
      } catch(err){
        console.error('Erro POST ocorrencia (professor):', err);
        alert('Erro ao comunicar com o servidor (ver console).');
      }
    }

    function clearProfessorForm(){
      document.getElementById('professor_select').value=''; document.getElementById('turma_select').value=''; document.getElementById('alunos_selected_placeholder').textContent='Clique para selecionar';
      document.getElementById('selectedPills').innerHTML=''; document.getElementById('descricao_prof').value=''; alunosSelecionados = []; document.getElementById('ra_prof').value=''; Array.from(document.querySelectorAll('input[name="irreg"]')).forEach(cb=>cb.checked=false); document.getElementById('data_prof').value=new Date().toISOString().split('T')[0];
    }

    /* -------------------------
      Histórico (GET)
      ------------------------- */
    async function carregarHistoricoGestao(){
      const container = document.getElementById('historyListGestao');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="muted">Carregando histórico...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_GESTAO)}`);
        const json = await resp.json();
        const ocorrs = (json && (json.occurrences || json.data)) || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length===0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }
        ocorrs.slice().reverse().forEach(r=>{
          const id = r.id || r.ID || r.Id || '';
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const ra = r.RA || r.ra || r.col5 || '';
          const disciplina = r.DISCIPLINA || r.disciplina || r.col6 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col7 || '';
          const desc = r.DESCRICAO || r.description || r.col8 || '';
          const div = document.createElement('div'); div.className='historyItem';
          div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${date}</strong> — <span class="muted">${prof}</span></div></div>
            <div style="margin-top:8px"><strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/><strong>RA(s):</strong> ${ra || 'N/A'}<br/><strong>Turma:</strong> ${turma || 'N/A'}<br/><strong>Disciplina:</strong> ${disciplina || 'N/A'}<br/><strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/><em>${desc || ''}</em></div>
            <div style="margin-top:8px;font-size:12px;color:#666">ID: ${id}</div>`;
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoGestao:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>';
      }
    }

    async function carregarHistoricoProfessor(){
      const container = document.getElementById('historyListProfessor');
      container.innerHTML = `<div style="display:flex;align-items:center;gap:8px"><div class="muted">Carregando histórico...</div></div>`;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${encodeURIComponent(SHEET_PROF)}`);
        const json = await resp.json();
        const ocorrs = (json && (json.occurrences || json.data)) || [];
        container.innerHTML = '';
        if(!ocorrs || ocorrs.length===0){ container.innerHTML = '<div class="muted">Nenhuma ocorrência encontrada.</div>'; return; }
        ocorrs.slice().reverse().forEach(r=>{
          const id = r.id || r.ID || r.Id || '';
          const date = r.DATA || r.date || r.col1 || '';
          const prof = r.PROFESSOR || r.professor || r.col2 || '';
          const turma = r.TURMA || r.studentClass || r.col3 || '';
          const aluno = r.ALUNO || r.student || r.col4 || '';
          const irreg = r.IRREGULARIDADES || r.irregularities || r.col5 || '';
          const desc = r.DESCRICAO || r.description || r.col6 || '';
          const div = document.createElement('div'); div.className='historyItem';
          div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${date}</strong> — <span class="muted">${prof}</span></div></div>
            <div style="margin-top:8px"><strong>Aluno(s):</strong> ${aluno || 'N/A'}<br/><strong>Turma:</strong> ${turma || 'N/A'}<br/><strong>Irregularidades:</strong> ${irreg || 'N/A'}<br/><em>${desc || ''}</em></div>
            <div style="margin-top:8px;font-size:12px;color:#666">ID: ${id}</div>`;
          container.appendChild(div);
        });
      } catch(err){
        console.error('Erro carregarHistoricoProfessor:', err);
        container.innerHTML = '<div class="muted">Erro ao carregar histórico (ver console).</div>';
      }
    }

    /* -------------------------
      Delete & gerar PDF via backend (se implementado no Apps Script)
      ------------------------- */
    async function deleteOccurrence(occurrenceId){
      if(!occurrenceId){ alert('ID inválido para exclusão.'); return; }
      if(!confirm('Confirma exclusão desta ocorrência (ID '+occurrenceId+')?')) return;
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=delete-occurrence`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ occurrenceId, sheet: SHEET_GESTAO }) });
        const j = await resp.json();
        if(j && j.status === 'success'){ alert('Ocorrência excluída.'); carregarHistoricoGestao(); } else alert('Erro ao excluir: ' + (j && j.message ? j.message : 'Resposta inesperada'));
      } catch(err){ console.error('Erro deleteOccurrence:', err); alert('Erro ao comunicar com servidor.'); }
    }

    async function generatePdfFromBackend(occurrenceId){
      if(!occurrenceId){ alert('ID inválido para geração de PDF.'); return; }
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=generate-pdf`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ occurrenceId, sheet: SHEET_GESTAO }) });
        const j = await resp.json();
        if(j && j.status === 'success' && j.pdfUrl){ window.open(j.pdfUrl, '_blank'); } else alert('Servidor não retornou URL do PDF. Resposta: ' + JSON.stringify(j));
      } catch(err){ console.error('Erro generatePdfFromBackend:', err); alert('Erro ao pedir geração de PDF.'); }
    }

    /* -------------------------
      Gerar PDF local (fazer download do formulário)
      ------------------------- */
    function generatePDFLocal(){
      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('Registro de Ocorrência', 14, 20);
        const turma = document.getElementById('serie_gestao').value || '';
        const alunos = alunosSelecionadosGestao.map(a=>a.nome + (a.ra?` (${a.ra})`:'' )).join(', ') || '';
        const ras = document.getElementById('ra_gestao').value || '';
        const prof = document.getElementById('professor_gestao').value || '';
        const disciplina = document.getElementById('disciplina_gestao').value || '';
        const classificacao = document.getElementById('classificacao_gestao').value || '';
        const desc = document.getElementById('descricao_gestao').value || '';
        let y = 36;
        if(turma){ doc.text(`Turma: ${turma}`, 14, y); y+=8; }
        if(alunos){ doc.text(`Aluno(s): ${alunos}`, 14, y); y+=8; }
        if(ras){ doc.text(`RA(s): ${ras}`, 14, y); y+=8; }
        if(prof){ doc.text(`Professor: ${prof}`, 14, y); y+=8; }
        if(disciplina){ doc.text(`Disciplina: ${disciplina}`, 14, y); y+=8; }
        if(classificacao){ doc.text(`Classificação: ${classificacao}`, 14, y); y+=8; }
        doc.text('Descrição:', 14, y); y+=8;
        const split = doc.splitTextToSize(desc || 'Sem descrição', 180);
        doc.text(split, 14, y);
        doc.save(`ocorrencia_${Date.now()}.pdf`);
      } catch(err){ console.error('Erro gerar PDF local:', err); alert('Erro ao gerar PDF local (ver console).'); }
    }

    /* -------------------------
      Util / fallbacks
      ------------------------- */
    function getFallbackProfessores(){
      return [
        "ALEX LUTH PEREIRA MARANHAO","ALEXSANDRA PAULA VARELLA DE SOUZA","ALISON VASCONCELOS BESERRA",
        "AMAURI TEODORO DE OLIVEIRA","ANA PAULA DOS SANTOS","ANDREIA DOS SANTOS FREITAS","ANDREIA MADUREIRA REIS"
      ];
    }

    function downloadDocument(){ alert("Funcionalidade de download de template será implementada em breve."); }
  </script>
</body>
</html>
