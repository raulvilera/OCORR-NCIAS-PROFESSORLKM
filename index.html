<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Registro de Ocorrências Escolares</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* === (Mantive seu CSS base; apenas removi inconsistências) === */
    :root {
      --primary-color:#1a73e8; --primary-dark:#0d47a1; --secondary-color:#f8f9fa;
      --accent-color:#f1c40f; --success-color:#2ecc71; --error-color:#e74c3c;
      --border-color:#dadce0; --text-color:#202124; --light-text:#5f6368;
      --card-bg:#ffffff; --shadow:0 4px 12px rgba(0,0,0,.1); --transition:all .3s ease;
      --hover-bg:#f0f5ff;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI','Roboto','Helvetica Neue',Arial,sans-serif}
    body{background:linear-gradient(135deg,#f5f7fa 0%,#e4edf5 100%);color:var(--text-color);line-height:1.6;min-height:100vh;padding-bottom:60px}
    .container{max-width:1200px;margin:0 auto;padding:20px}
    header{background:linear-gradient(135deg,#2ecc71 0%,#3498db 100%);border-bottom:1px solid var(--border-color);padding:15px 0;box-shadow:var(--shadow);position:sticky;top:0;z-index:100}
    .header-content{display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto;padding:0 20px}
    .logo{display:flex;align-items:center;gap:15px}
    .logo-icon{background:rgba(255,255,255,0.2);color:#fff;width:55px;height:55px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 5px 15px rgba(0,0,0,.1);backdrop-filter:blur(10px)}
    .logo-text h1{font-size:1.6rem;color:#fff;font-weight:700;text-shadow:0 2px 4px rgba(0,0,0,.2)}
    .logo-text p{font-size:.9rem;color:rgba(255,255,255,.9);margin-top:3px;text-shadow:0 1px 2px rgba(0,0,0,.1)}
    main{padding:30px 0}
    .dashboard{display:grid;grid-template-columns:1fr 350px;gap:25px;margin-bottom:30px}
    .stats-card{background:linear-gradient(135deg,#2ecc71 0%,#3498db 100%);color:#fff;border-radius:16px;padding:25px;box-shadow:var(--shadow);position:relative;overflow:hidden}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;margin-top:20px;position:relative;z-index:2}
    .stat-item{background:rgba(255,255,255,.15);border-radius:12px;padding:15px;text-align:center;backdrop-filter:blur(10px);box-shadow:0 4px 6px rgba(0,0,0,.1);transition:var(--transition)}
    .stat-item:hover{transform:translateY(-5px);background:rgba(255,255,255,.25)}
    .stat-value{font-size:2.2rem;font-weight:700;margin:10px 0}
    .stat-label{font-size:.95rem;opacity:.9}
    .card{background:var(--card-bg);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;margin-bottom:25px;border:1px solid var(--border-color);transition:var(--transition)}
    .card:hover{transform:translateY(-5px);box-shadow:0 12px 25px rgba(0,0,0,.15)}
    .card-header{background:linear-gradient(135deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:#fff;padding:20px 30px;font-size:1.35rem;font-weight:600;display:flex;align-items:center;gap:12px}
    .card-body{padding:30px}
    .form-group{margin-bottom:25px}
    label{display:block;margin-bottom:12px;font-weight:600;color:var(--text-color);font-size:1.1rem;cursor:pointer}
    .required::after{content:" *";color:var(--error-color)}
    input,select,textarea{width:100%;padding:15px;border:2px solid #e1e5eb;border-radius:10px;font-size:16px;transition:var(--transition);background:#f8fafc}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary-color);box-shadow:0 0 0 4px rgba(26,115,232,.2);background:#fff;transform:translateY(-2px)}
    .input-error{border-color:var(--error-color)!important;box-shadow:0 0 0 3px rgba(231,76,60,.2)!important}
    textarea{min-height:150px;resize:vertical}
    .checkbox-group{margin-bottom:20px}
    .checkbox-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:18px}
    .checkbox-item{background:#f8fafc;padding:15px;border-radius:10px;border:1px solid #e1e5eb;transition:var(--transition);display:flex;align-items:center;cursor:pointer}
    .checkbox-item:hover{background:#e8f0fe;border-color:var(--primary-color);transform:translateY(-5px);box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .checkbox-item input{width:auto;margin-right:12px;transform:scale(1.2);cursor:pointer}
    .chart-container{position:relative;width:50px;height:50px;margin-right:15px}
    .chart-value{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-weight:700;font-size:14px;color:var(--primary-dark);z-index:10}
    .form-row{display:flex;gap:25px;margin-bottom:25px}
    .form-col{flex:1}
    .btn{padding:16px 32px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;transition:var(--transition);display:inline-flex;align-items:center;justify-content:center;gap:12px;box-shadow:0 5px 15px rgba(0,0,0,.1)}
    .btn-primary{background:linear-gradient(135deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:#fff}
    .btn-primary:hover{background:linear-gradient(135deg,#0d62d9 0%,#0a4ebf 100%);transform:translateY(-3px);box-shadow:0 8px 20px rgba(26,115,232,.35)}
    .btn-secondary{background:linear-gradient(135deg,#f8f9fa 0%,#e8eaed 100%);color:var(--text-color);border:1px solid var(--border-color)}
    .btn-secondary:hover{background:linear-gradient(135deg,#e8eaed 0%,#d7d9dd 100%);transform:translateY(-3px)}
    .btn:disabled{opacity:.7;cursor:not-allowed;transform:none}
    .actions{display:flex;gap:18px;padding-top:25px;border-top:1px solid var(--border-color);margin-top:25px}
    .alert{padding:20px;border-radius:10px;margin-bottom:25px;display:none;font-size:17px;font-weight:500;align-items:center;gap:15px}
    .alert-success{background:linear-gradient(135deg,rgba(46,204,113,.15) 0%,rgba(39,174,96,.15) 100%);border:1px solid var(--success-color);color:#27ae60}
    .alert-error{background:linear-gradient(135deg,rgba(231,76,60,.15) 0%,rgba(192,57,43,.15) 100%);border:1px solid var(--error-color);color:#c0392b}
    .notification{position:fixed;top:20px;right:20px;padding:15px 25px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.15);z-index:1000;display:flex;align-items:center;gap:12px;opacity:0;transform:translateX(100%);transition:all .4s ease}
    .notification.show{opacity:1;transform:translateX(0)}
    .notification.success{background:var(--success-color);color:#fff}
    .notification.error{background:var(--error-color);color:#fff}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite;margin-right:10px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .tabs{display:flex;background:#fff;border-radius:10px;overflow:hidden;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .tab-button{flex:1;padding:15px 20px;background:#e0e0e0;border:none;font-size:16px;font-weight:600;cursor:pointer;transition:var(--transition);color:var(--light-text)}
    .tab-button.active{background:var(--primary-color);color:#fff}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .registros-table{width:100%;border-collapse:collapse;margin-top:20px;background:#fff;border-radius:10px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,.1)}
    .registros-table th{background:linear-gradient(135deg,var(--primary-color) 0%,var(--primary-dark) 100%);color:#fff;padding:15px;text-align:left;font-weight:600}
    .registros-table td{padding:15px;border-bottom:1px solid var(--border-color);color:var(--text-color)}
    .registros-table tr:hover{background:var(--hover-bg)}
    .btn-action{padding:8px 12px;border-radius:6px;font-size:14px;display:inline-flex;align-items:center;gap:5px;cursor:pointer;transition:var(--transition);margin-right:5px}
    .btn-edit{background:#f0f5ff;color:var(--primary-color);border:1px solid var(--primary-color)}
    .btn-delete{background:#fff0f0;color:var(--error-color);border:1px solid var(--error-color)}
    .empty-state{text-align:center;padding:40px 20px;color:var(--light-text)}
    .empty-state i{font-size:48px;margin-bottom:15px;color:#d0d0d0}
    footer{background:#fff;border-top:1px solid var(--border-color);padding:25px 0;text-align:center;color:var(--light-text);font-size:15px;position:fixed;bottom:0;width:100%}
    @media (max-width: 992px){.dashboard{grid-template-columns:1fr}}
    @media (max-width: 768px){
      .form-row{flex-direction:column}
      .header-content{flex-direction:column;gap:15px;text-align:center}
      .actions{flex-direction:column}
      .stats-grid{grid-template-columns:1fr}
      .checkbox-container{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-graduation-cap"></i></div>
        <div class="logo-text">
          <h1>Registro de Ocorrências Escolares</h1>
          <p>Sistema integrado ao Google Sheets</p>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <main>
      <div class="tabs">
        <button class="tab-button active" data-tab="form-tab">Cadastrar Ocorrências</button>
        <button class="tab-button" data-tab="records-tab">Registros</button>
        <button class="tab-button" data-tab="stats-tab">Estatísticas</button>
      </div>

      <!-- Formulário -->
      <div id="form-tab" class="tab-content active">
        <div class="dashboard">
          <div>
            <div class="card">
              <div class="card-header"><i class="fas fa-clipboard-list"></i> Informações de Ocorrência</div>
              <div class="card-body">
                <div id="alert" class="alert">
                  <i class="fas fa-check-circle"></i>
                  <span id="alert-message"></span>
                </div>

                <form id="occurrenceForm">
                  <div class="form-row">
                    <div class="form-col">
                      <div class="form-group">
                        <label for="professor" class="required">Nome do professor</label>
                        <select id="professor" required>
                          <option value="">Selecione seu nome</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-col">
                      <div class="form-group">
                        <label for="occurrenceDate" class="required">Data da ocorrência</label>
                        <input type="date" id="occurrenceDate" required/>
                      </div>
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-col">
                      <div class="form-group">
                        <label for="studentClass" class="required">Turma</label>
                        <select id="studentClass" required>
                          <option value="">Selecione a turma</option>
                          <!-- (mantive as opções da sua versão) -->
                          <option value="6° ANO A MANHA">6° ANO A MANHA</option>
                          <option value="6° ANO B MANHA">6° ANO B MANHA</option>
                          <option value="6° ANO C MANHA">6° ANO C MANHA</option>
                          <option value="6° ANO D MANHA">6° ANO D MANHA</option>
                          <option value="6° ANO E TARDE">6° ANO E TARDE</option>
                          <option value="6° ANO F TARDE">6° ANO F TARDE</option>
                          <option value="7° ANO A TARDE">7° ANO A TARDE</option>
                          <option value="7° ANO B TARDE">7° ANO B TARDE</option>
                          <option value="7° ANO C TARDE">7° ANO C TARDE</option>
                          <option value="7° ANO D TARDE">7° ANO D TARDE</option>
                          <option value="7° ANO E TARDE">7° ANO E TARDE</option>
                          <option value="7° ANO F TARDE">7° ANO F TARDE</option>
                          <option value="8° ANO A TARDE">8° ANO A TARDE</option>
                          <option value="8° ANO B TARDE">8° ANO B TARDE</option>
                          <option value="8° ANO C TARDE">8° ANO C TARDE</option>
                          <option value="8° ANO D TARDE">8° ANO D TARDE</option>
                          <option value="9° ANO A TARDE">9° ANO A TARDE</option>
                          <option value="9° ANO B TARDE">9° ANO B TARDE</option>
                          <option value="9° ANO C TARDE">9° ANO C TARDE</option>
                          <option value="9° ANO D TARDE">9° ANO D TARDE</option>
                          <option value="1ª SERIE A MANHA">1ª SERIE A MANHA</option>
                          <option value="1ª SERIE B MANHA">1ª SERIE B MANHA</option>
                          <option value="1ª SERIE C MANHA">1ª SERIE C MANHA</option>
                          <option value="1ª SERIE D MANHA">1ª SERIE D MANHA</option>
                          <option value="1ª SERIE E MANHA">1ª SERIE E MANHA</option>
                          <option value="1ª SERIE F MANHA">1ª SERIE F MANHA</option>
                          <option value="1ª SERIE G TARDE">1ª SERIE G TARDE</option>
                          <option value="1ª SERIE H NOITE">1ª SERIE H NOITE</option>
                          <option value="1ª SERIE I NOITE">1ª SERIE I NOITE</option>
                          <option value="2ª SERIE A MANHA">2ª SERIE A MANHA</option>
                          <option value="2ª SERIE B MANHA">2ª SERIE B MANHA</option>
                          <option value="2ª SERIE C MANHA">2ª SERIE C MANHA</option>
                          <option value="2ª SERIE D MANHA">2ª SERIE D MANHA</option>
                          <option value="2ª SERIE E MANHA">2ª SERIE E MANHA</option>
                          <option value="2ª SERIE F NOITE">2ª SERIE F NOITE</option>
                          <option value="2ª SERIE G NOITE">2ª SERIE G NOITE</option>
                          <option value="2ª SERIE H NOITE">2ª SERIE H NOITE</option>
                          <option value="3ª SERIE A MANHA">3ª SERIE A MANHA</option>
                          <option value="3ª SERIE B MANHA">3ª SERIE B MANHA</option>
                          <option value="3ª SERIE C MANHA">3ª SERIE C MANHA</option>
                          <option value="3ª SERIE D NOITE">3ª SERIE D NOITE</option>
                          <option value="3ª SERIE E NOITE">3ª SERIE E NOITE</option>
                          <option value="3ª SERIE F NOITE">3ª SERIE F NOITE</option>
                          <option value="4050 - ADMINISTRAÇÃO - 2ª SERIE A MANHA">4050 - ADMINISTRAÇÃO - 2ª SERIE A MANHA</option>
                        </select>
                      </div>
                    </div>
                    <div class="form-col">
                      <div class="form-group">
                        <label for="student" class="required">Nome do aluno</label>
                        <select id="student" required disabled>
                          <option value="">Selecione primeiro a turma</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <!-- Irregularidades (mantidas) -->
                  <div class="checkbox-group">
                    <label>Irregularidades (opcional):</label>
                    <div class="checkbox-container" id="irregsContainer">
                      <!-- exemplos (mantidos) -->
                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Não fez a lição"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity1" name="irregularity" value="Não fez a lição"/>
                        <label for="irregularity1">Não fez a lição</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Não trouxe material"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity2" name="irregularity" value="Não trouxe material"/>
                        <label for="irregularity2">Não trouxe material</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Fora do lugar constantemente durante a aula"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity3" name="irregularity" value="Fora do lugar constantemente durante a aula"/>
                        <label for="irregularity3">Fora do lugar durante a aula</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Chegou atrasado"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity4" name="irregularity" value="Chegou atrasado"/>
                        <label for="irregularity4">Chegou atrasado</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Circulando no corredor durante a aula"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity5" name="irregularity" value="Circulando no corredor durante a aula"/>
                        <label for="irregularity5">Circulando no corredor</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Uso indevido do celular durante a aula"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity6" name="irregularity" value="Uso indevido do celular durante a aula"/>
                        <label for="irregularity6">Uso indevido do celular</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Interrompe a aula constantemente"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity7" name="irregularity" value="Interrompe a aula constantemente"/>
                        <label for="irregularity7">Interrompe a aula constantemente</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Falta de cuidado com o ambiente e o material"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity8" name="irregularity" value="Falta de cuidado com o ambiente e o material"/>
                        <label for="irregularity8">Falta de cuidado com ambiente/material</label>
                      </div>

                      <div class="checkbox-item">
                        <div class="chart-container">
                          <canvas class="donut-chart" width="50" height="50" data-irregularity="Vestimenta inadequada"></canvas>
                          <span class="chart-value">0</span>
                        </div>
                        <input type="checkbox" id="irregularity9" name="irregularity" value="Vestimenta inadequada"/>
                        <label for="irregularity9">Vestimenta inadequada</label>
                      </div>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="description">Breve relato do ocorrido</label>
                    <textarea id="description" placeholder="Descreva detalhadamente a ocorrência..."></textarea>
                  </div>

                  <div class="actions">
                    <button type="submit" class="btn btn-primary" id="submitBtn">
                      <i class="fas fa-paper-plane"></i> CADASTRAR
                    </button>
                    <button type="button" id="clearBtn" class="btn btn-secondary">
                      <i class="fas fa-broom"></i> Limpar
                    </button>
                    <button type="button" id="exportBtn" class="btn btn-secondary">
                      <i class="fas fa-file-export"></i> Exportar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>

          <div>
            <div class="stats-card">
              <div class="card-header"><i class="fas fa-chart-line"></i> Estatísticas do Sistema</div>
              <div class="stats-grid">
                <div class="stat-item"><div class="stat-value" id="totalOccurrences">0</div><div class="stat-label">Ocorrências</div></div>
                <div class="stat-item"><div class="stat-value" id="totalStudents">0</div><div class="stat-label">Alunos</div></div>
                <div class="stat-item"><div class="stat-value">40</div><div class="stat-label">Turmas</div></div>
                <div class="stat-item"><div class="stat-value">64</div><div class="stat-label">Professores</div></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Registros -->
      <div id="records-tab" class="tab-content">
        <div class="card">
          <div class="card-header"><i class="fas fa-list"></i> Registros de Ocorrências</div>
          <div class="card-body">
            <div style="overflow-x:auto">
              <table id="registrosTable" class="registros-table">
                <thead>
                  <tr>
                    <th>Data</th><th>Professor</th><th>Turma</th><th>Aluno</th><th>Irregularidades</th><th>Descrição</th><th>Ações</th>
                  </tr>
                </thead>
                <tbody id="registrosTableBody"></tbody>
              </table>
            </div>
            <div id="noRecordsMessage" class="empty-state" style="display:none;">
              <i class="fas fa-clipboard-list"></i>
              <h3>Nenhuma ocorrência registrada</h3>
              <p>Quando você registrar ocorrências, elas aparecerão aqui.</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Estatísticas -->
      <div id="stats-tab" class="tab-content">
        <div class="card">
          <div class="card-header"><i class="fas fa-chart-pie"></i> Estatísticas Gerais</div>
          <div class="card-body">
            <div class="stats-grid">
              <div class="stat-item"><div class="stat-value" id="totalOccurrencesStats">0</div><div class="stat-label">Total de Ocorrências</div></div>
              <div class="stat-item"><div class="stat-value" id="mostFrequentIrregularity">-</div><div class="stat-label">Irregularidade mais frequente</div></div>
              <div class="stat-item"><div class="stat-value" id="mostAffectedClass">-</div><div class="stat-label">Turma com mais ocorrências</div></div>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <div id="notification" class="notification"><i class="fas icon"></i><div class="content"></div><button class="close"><i class="fas fa-times"></i></button></div>
  <footer><div>Sistema de Gestão Escolar © 2025</div></footer>

  <script>
    /* ===== CONFIG DA API ===== */
    const API_CONFIG = {
      BASE_URL: 'https://script.google.com/macros/s/AKfycbwODVdUyzlGO9FVIEChklO4DvIVzxYPOk0Ej8EZzx-Nt9vKCS4LVxaeRBEqhJ0NYTX7/exec', // <<<<<<<<<<<<<<<< TROQUE AQUI
      TIMEOUT: 30000,
      MAX_RETRIES: 2
    };

    /* ===== CLIENTE API ===== */
    class APIClient {
      constructor(config) {
        this.baseUrl = config.BASE_URL;
        this.timeout = config.TIMEOUT;
        this.maxRetries = config.MAX_RETRIES;
      }

      async makeRequest(url, options = {}) {
        const { method = 'GET', body = null, retries = this.maxRetries } = options;

        for (let attempt = 0; attempt <= retries; attempt++) {
          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), this.timeout);

          try {
            const fetchOptions = {
              method,
              mode: 'cors',
              cache: 'no-cache',
              credentials: 'omit',
              headers: { 'Content-Type':'application/json', 'Accept':'application/json' },
              signal: controller.signal
            };
            if (body && method !== 'GET') fetchOptions.body = JSON.stringify(body);

            const resp = await fetch(url, fetchOptions);
            clearTimeout(timeoutId);

            if (!resp.ok) throw new Error(`HTTP ${resp.status}: ${resp.statusText}`);

            const ct = resp.headers.get('content-type') || '';
            const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());

            if (data.status && data.status !== 'success') throw new Error(data.message || 'Erro do servidor');
            return data;
          } catch (err) {
            clearTimeout(timeoutId);
            if (attempt === retries) throw err;
            await new Promise(r => setTimeout(r, Math.min(1000 * Math.pow(2, attempt) + Math.random()*500, 5000)));
          }
        }
      }

      // GETs
      async getStudents(className) {
        const url = `${this.baseUrl}?action=getStudents&class=${encodeURIComponent(className)}&ts=${Date.now()}`;
        const res = await this.makeRequest(url);
        return res.students || [];
      }
      async getStudentStats(studentName) {
        const url = `${this.baseUrl}?action=getStudentStats&student=${encodeURIComponent(studentName)}&ts=${Date.now()}`;
        return await this.makeRequest(url);
      }
      async getAllOccurrences() {
        const url = `${this.baseUrl}?action=getAllOccurrences&ts=${Date.now()}`;
        const res = await this.makeRequest(url);
        return res.occurrences || [];
      }
      async getOccurrenceById(id) {
        const url = `${this.baseUrl}?action=getOccurrenceById&id=${encodeURIComponent(id)}&ts=${Date.now()}`;
        const res = await this.makeRequest(url);
        return res.occurrence;
      }
      async getStatistics() {
        const url = `${this.baseUrl}?action=getStatistics&ts=${Date.now()}`;
        return await this.makeRequest(url);
      }

      // POSTs
      async addOccurrence(data) {
        return await this.makeRequest(this.baseUrl, {
          method: 'POST',
          body: { action:'addOccurrence', ...data, timestamp: Date.now() }
        });
      }
      async updateOccurrence(data) {
        return await this.makeRequest(this.baseUrl, {
          method: 'POST',
          body: { action:'updateOccurrence', ...data, timestamp: Date.now() }
        });
      }
      async deleteOccurrence(id) {
        return await this.makeRequest(this.baseUrl, {
          method: 'POST',
          body: { action:'deleteOccurrence', id, timestamp: Date.now() }
        });
      }
    }

    // ===== APP =====
    const api = new APIClient(API_CONFIG);

    document.addEventListener('DOMContentLoaded', () => {
      // Emails dos professores (mantidos do seu arquivo)
      const teacherEmails = {
                        "ALEX LUTH PEREIRA MARANHAO": "luth@prof.educacao.sp.gov.br",
                "ALEXSANDRA PAULA VARELLA DE SOUZA": "avarella@prof.educacao.sp.gov.br",
                "ALISON VASCONCELOS BESERRA": "alisonv@prof.educacao.sp.gov.br",
                "AMAURI TEODORO DE OLIVEIRA": "amaurit@prof.educacao.sp.gov.br",
                "ANA PAULA DOS SANTOS": "paulasantosa@prof.educacao.sp.gov.br",
                "ANDREIA DOS SANTOS FREITAS": "sanfreitas@prof.educacao.sp.gov.br",
                "ANDREIA MADUREIRA REIS": "andreiamadureira@prof.educacao.sp.gov.br",
                "ANTONIO CARLOS DE OLIVEIRA": "antoniocarloso@prof.educacao.sp.gov.br",
                "ANTONIO RAMOS DE ARAUJO": "antonioramosaraujo@prof.educacao.sp.gov.br",
                "ANTONIO WILTON WANDERLEY CABRAL": "antoniowilton@prof.educacao.sp.gov.br",
                "AUGUSTO LINO PESSOA NETO": "augustolino@prof.educacao.sp.gov.br",
                "AUREA MARIA DE JESUS MARQUES": "aureamaria@prof.educacao.sp.gov.br",
                "CAROLINA PERNOMIAN PARUSSOLO": "carolinapernomian@prof.educacao.sp.gov.br",
                "CASSIA OLIVEIRA ANTONIAZI": "cassiaosilva@prof.educacao.sp.gov.br",
                "CLAUDINEIA DE AGUIAR LIMA": "aguiarl@prof.educacao.sp.gov.br",
                "DANIEL DE FREITAS ALMEIDA": "danielalmeida@prof.educacao.sp.gov.br",
                "DANIEL LOPES BARBOSA": "daniellopesbarbosa@prof.educacao.sp.gov.br",
                "DANIELA FERREIRA LIMA": "danielafilma@prof.educacao.sp.gov.br",
                "DANIELLE LUCIA BATISTA DE ALMEIDA": "danieleLucia@prof.educacao.sp.gov.br",
                "EDIANE VIEIRA DA SILVA": "ediane@prof.educacao.sp.gov.br",
                "EDILEUSA NUNES PEREIRA": "edileusa@prof.educacao.sp.gov.br",
                "EDUARDO HENRIQUE DA FONSECA": "henriquefonseca@prof.educacao.sp.gov.br",
                "ELIANE SANTOS SILVA": "essantos@prof.educacao.sp.gov.br",
                "ELIAS MONTEIRO DA SILVA": "elias1@prof.educacao.sp.gov.br",
                "ELISABETE APARECIDA PIRES": "elisabetepires@prof.educacao.sp.gov.br",
                "ELZA DE FARIA PEREIRA": "elzafariapereira@prof.educacao.sp.gov.br",
                "EMERSON GABLER DE ALMEIDA": "egabler@prof.educacao.sp.gov.br",
                "EUZELI ARAUJO DE OLIVEIRA": "euzeli@prof.educacao.sp.gov.br",
                "FABIANO AUGUSTO PIEDADE": "fabianoaugusto@prof.educacao.sp.gov.br",
                "FABIO CAMILO": "camilof@prof.educacao.sp.gov.br",
                "FERNANDO JOSE DA SILVA FILHO": "fernandojs@prof.educacao.sp.gov.br",
                "FLAVIA CRISTINA APARECIDA BICHLER": "flaviacri@prof.educacao.sp.gov.br",
                "FLAVIO CARDOSO FLEURY": "flaviofleury@prof.educacao.sp.gov.br",
                "FRANCISCA EDIVANIA DE MORAIS COSTA": "fedivania@prof.educacao.sp.gov.br",
                "GABRIELA SERIGHELLI DE MELO": "gabrielaserighelli@prof.educacao.sp.gov.br",
                "GELSON DE ALMEIDA BATISTA": "gelsonalmeida@prof.educacao.sp.gov.br",
                "GENILTON DE OLIVEIRA SILVA": "genilton@prof.educacao.sp.gov.br",
                "GIANI CRISTINA DO PRADO": "gianiprado@prof.educacao.sp.gov.br",
                "INGRYD CAROLINA SUGUIMOTO VIEIRA": "ingryd@prof.educacao.sp.gov.br",
                "IVANILDES DOS SANTOS OSHIKAWA": "oshikawa@prof.educacao.sp.gov.br",
                "JANINA DOS PASSOS BRAGA DE ALMEIDA": "janinabraga@prof.educacao.sp.gov.br",
                "JOSE APARECIDO DA SILVA": "joseaparecidosilva@prof.educacao.sp.gov.br",
                "JUAREZ GOMES DE MAGALHAES FILHO": "juarezgomes@prof.educacao.sp.gov.br",
                "JUREMA SOLEDADE FURINI SANTOS": "juremas@prof.educacao.sp.gov.br",
                "KATIUSCIA ALVES BOMFIM": "katiusciabornfim@prof.educacao.sp.gov.br",
                "LUANA CAROLINE ALVES LIMA": "luanalima01@prof.educacao.sp.gov.br",
                "LUANA DE FREITAS SILVA": "luanafreitas@prof.educacao.sp.gov.br",
                "LUCIANA NOVAIS CORREIA SANTOS": "novaiscorreia@prof.educacao.sp.gov.br",
                "LUCIANO MOREIRA DE AZEVEDO": "lucianomoreira@prof.educacao.sp.gov.br",
                "MARCIEL DA SILVA": "marcielsilva@prof.educacao.sp.gov.br",
                "MARIA HELENA CUNHA MORO": "marcunha@prof.educacao.sp.gov.br",
                "MARIA QUITERIA FERREIRA DOS SANTOS": "quiteriasantos@prof.educacao.sp.gov.br",
                "MARINA DA CONCEICAO FRANCISCO SILVA": "marinafrancisco@prof.educacao.sp.gov.br",
                "MAURICIO DE BARROS SANTOS": "mauriciobsantos@prof.educacao.sp.gov.br",
                "MICHELE DE PINHO MORAES": "michelepinho@prof.educacao.sp.gov.br",
                "MOISES ANTONIO DE BARROS": "moisesbarros@prof.educacao.sp.gov.br",
                "PAULA ARMANI VILA": "paulaarmani@prof.educacao.sp.gov.br",
                "PAULO ROBERTO DA SILVA ITO": "pauloito@prof.educacao.sp.gov.br",
                "PEDRO ZANOTTI FILHO": "pedrozanotti@prof.educacao.sp.gov.br",
                "RAUL PEREIRA VILERA JUNIOR": "vilera@prof.educacao.sp.gov.br",
                "REGIANE CURTI DE SOUZA OLIVEIRA": "regianecurti@prof.educacao.sp.gov.br",
                "REGINA DA SILVA CASTRO": "reginasilvacastro@prof.educacao.sp.gov.br",
                "RICARDO AMERICO DA SILVA": "ricardoamerico@prof.educacao.sp.gov.br",
                "ROBERTO SALGADO": "robertosalgado@prof.educacao.sp.gov.br",
                "RODRIGO VIEIRA": "rodrigovieira1@prof.educacao.sp.gov.br",
                "ROSANGELA CAFASSO MOREIRA": "cafasso@prof.educacao.sp.gov.br",
                "ROSIMERY DE SOUZA PESSOA": "rosimerypessoa@prof.educacao.sp.gov.br",
                "ROSMARA DA SILVA CARDOSO": "rosmaracardoso@prof.educacao.sp.gov.br",
                "SANDRA CRISTINA MACEDO MORAES": "sandracristinamacedo@prof.educacao.sp.gov.br",
                "SELMA GOMES DA SILVA": "selmagomess@prof.educacao.sp.gov.br",
                "SERGIO AGRIPINO VILLA NOVA": "sergioagripino@prof.educacao.sp.gov.br",
                "SOLANGE ALMEIDA DA SILVA": "almeidafazio@prof.educacao.sp.gov.br",
                "SUZINEIDE SILVA DE FREITAS": "suzineidefreitas@prof.educacao.sp.gov.br",
                "THIAGO FABIANO BRITO": "thiagofabiano@prof.educacao.sp.gov.br",
                "TITTO AUGUSTO NASCIMENTO SILVA": "titto@prof.educacao.sp.gov.br",
                "VANDERSON HYPPOLITO": "vhypolito@prof.educacao.sp.gov.br",
                "VANESSA IVETE GOMES DOS SANTOS": "vanessaivete@prof.educacao.sp.gov.br",
                "VANIA PENHA DE BARROS": "vaniapenha@prof.educacao.sp.gov.br",
                "VIVIANE LEAL CAMERA DE MORAES": "camera@prof.educacao.sp.gov.br",
                "WILSON RODRIGUES MOTA": "wmota@prof.educacao.sp.gov.br"
            };

      // DOM
      const form = document.getElementById('occurrenceForm');
      const clearBtn = document.getElementById('clearBtn');
      const submitBtn = document.getElementById('submitBtn');
      const studentSelect = document.getElementById('student');
      const classSelect = document.getElementById('studentClass');
      const professorSelect = document.getElementById('professor');
      const totalOccurrencesEl = document.getElementById('totalOccurrences');
      const exportBtn = document.getElementById('exportBtn');
      const registrosTableBody = document.getElementById('registrosTableBody');
      const notification = document.getElementById('notification');
      const notificationIcon = notification.querySelector('.icon');
      const notificationContent = notification.querySelector('.content');
      const notificationClose = notification.querySelector('.close');
      const noRecordsMessage = document.getElementById('noRecordsMessage');
      const tabButtons = document.querySelectorAll('.tab-button');
      const tabContents = document.querySelectorAll('.tab-content');
      const alertBox = document.getElementById('alert');
      const alertMessage = document.getElementById('alert-message');

      const charts = {};
      let currentEditId = null;

      // Preencher professores
      Object.keys(teacherEmails).forEach(name => {
        const opt = document.createElement('option');
        opt.value = name; opt.textContent = name;
        professorSelect.appendChild(opt);
      });

      // Data hoje
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('occurrenceDate').value = today;

      // Tabs
      tabButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const tabId = btn.getAttribute('data-tab');
          tabButtons.forEach(b=>b.classList.remove('active'));
          tabContents.forEach(c=>c.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(tabId).classList.add('active');

          if (tabId==='records-tab') loadRegistrosTable();
          if (tabId==='stats-tab') loadStatistics();
        });
      });

      // Notificação
      function showNotification(type, message) {
        notification.classList.remove('success','error');
        notification.classList.add(type);
        notificationContent.textContent = message;
        notificationIcon.className = type==='success' ? 'fas fa-check-circle icon' : 'fas fa-exclamation-circle icon';
        notification.classList.add('show');
        setTimeout(()=> notification.classList.remove('show'), 5000);
      }
      notificationClose.addEventListener('click', ()=> notification.classList.remove('show'));

      // Alert
      function showAlert(type, message) {
        alertBox.classList.remove('alert-success','alert-error');
        alertBox.classList.add(`alert-${type}`);
        alertMessage.textContent = message;
        alertBox.style.display = 'flex';
        setTimeout(()=> alertBox.style.display='none', 5000);
      }

      // Donut
      function createDonutChart(canvas, value, maxValue=10) {
        const ctx = canvas.getContext('2d');
        const key = canvas.getAttribute('data-irregularity');
        if (charts[key]) charts[key].destroy();
        charts[key] = new Chart(ctx, {
          type:'doughnut',
          data:{ datasets:[{ data:[value, Math.max(0,maxValue-value)], backgroundColor:['#3498db','#e0e0e0'], borderWidth:0 }] },
          options:{ cutout:'70%', responsive:false, maintainAspectRatio:false, plugins:{ legend:{display:false}, tooltip:{enabled:false} } }
        });
        canvas.parentElement.querySelector('.chart-value').textContent = value;
      }

      function resetAllCharts() {
        document.querySelectorAll('.donut-chart').forEach(cv=> createDonutChart(cv, 0));
      }

      // Turma -> alunos
      classSelect.addEventListener('change', async function(){
        const turma = this.value;
        studentSelect.innerHTML = '<option value="">Carregando alunos...</option>';
        studentSelect.disabled = true;
        resetAllCharts();

        if (!turma) {
          studentSelect.innerHTML = '<option value="">Selecione uma turma</option>';
          return;
        }

        try {
          const students = await api.getStudents(turma);
          studentSelect.innerHTML = '<option value="">Selecione um aluno</option>';
          students.forEach(s=>{
            const opt=document.createElement('option'); opt.value=s; opt.textContent=s;
            studentSelect.appendChild(opt);
          });
          document.getElementById('totalStudents').textContent = students.length;
          studentSelect.disabled = false;
        } catch (err) {
          studentSelect.innerHTML = `<option value="">Erro: ${err.message}</option>`;
          showNotification('error','Erro ao carregar alunos: '+err.message);
        }
      });

      // Aluno -> estatísticas individuais
      studentSelect.addEventListener('change', async function(){
        if (!this.value) return resetAllCharts();
        try {
          const data = await api.getStudentStats(this.value);
          const stats = data.detailedStats || {};
          document.querySelectorAll('.donut-chart').forEach(cv=>{
            const irr = cv.getAttribute('data-irregularity');
            const count = stats[irr] || 0;
            createDonutChart(cv, count);
          });
        } catch (err) {
          showNotification('error','Erro ao carregar estatísticas: '+err.message);
        }
      });

      // Limpar
      clearBtn.addEventListener('click', ()=>{
        form.reset();
        document.getElementById('occurrenceDate').value = today;
        professorSelect.selectedIndex = 0;
        classSelect.selectedIndex = 0;
        studentSelect.innerHTML = '<option value="">Selecione primeiro a turma</option>';
        studentSelect.disabled = true;
        currentEditId = null;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> CADASTRAR';
        resetAllCharts();
        document.querySelectorAll('input[name="irregularity"]').forEach(ch=> ch.checked=false);
        document.querySelectorAll('.input-error').forEach(el=> el.classList.remove('input-error'));
        alertBox.style.display='none';
      });

      // Submit
      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const professor = professorSelect.value;
        const date = document.getElementById('occurrenceDate').value;
        const studentClass = classSelect.value;
        const student = studentSelect.value;
        const description = document.getElementById('description').value;

        document.querySelectorAll('.input-error').forEach(el=>el.classList.remove('input-error'));
        let hasError=false;
        if (!professor){ professorSelect.classList.add('input-error'); hasError=true; }
        if (!date){ document.getElementById('occurrenceDate').classList.add('input-error'); hasError=true; }
        if (!studentClass){ classSelect.classList.add('input-error'); hasError=true; }
        if (!student){ studentSelect.classList.add('input-error'); hasError=true; }
        if (hasError){ showAlert('error','Por favor, preencha todos os campos obrigatórios.'); return; }

        const irregularities = [];
        document.querySelectorAll('input[name="irregularity"]:checked').forEach(ch=> irregularities.push(ch.value));

        const occurrenceData = { professor, date, studentClass, student, irregularities: irregularities.join(', '), description };

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="loading"></div> Enviando...';
        try {
          if (currentEditId) {
            await api.updateOccurrence({ id: currentEditId, ...occurrenceData });
            showAlert('success','Ocorrência atualizada com sucesso!');
          } else {
            await api.addOccurrence(occurrenceData);
            showAlert('success','Ocorrência registrada com sucesso!');
          }
          clearBtn.click();
          await loadInitialData();
        } catch (err) {
          showAlert('error','Erro ao registrar ocorrência: '+err.message);
        } finally {
          submitBtn.disabled=false;
          submitBtn.innerHTML = currentEditId ? '<i class="fas fa-save"></i> ATUALIZAR' : '<i class="fas fa-paper-plane"></i> CADASTRAR';
        }
      });

      // Tabela
      async function loadRegistrosTable() {
        try {
          const occurrences = await api.getAllOccurrences();
          registrosTableBody.innerHTML = '';
          if (!occurrences.length) {
            noRecordsMessage.style.display='block';
            document.getElementById('registrosTable').style.display='none';
            return;
          }
          noRecordsMessage.style.display='none';
          document.getElementById('registrosTable').style.display='table';

          occurrences.forEach(o => addOccurrenceToTable(o));
        } catch (err) {
          showNotification('error','Erro ao carregar registros: '+err.message);
          noRecordsMessage.style.display='block';
          document.getElementById('registrosTable').style.display='none';
        }
      }

      function addOccurrenceToTable(o) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatDate(o.date)}</td>
          <td>${o.professor}</td>
          <td>${o.class}</td>
          <td>${o.student}</td>
          <td>${o.irregularities || 'Nenhuma'}</td>
          <td>${o.description || 'Sem descrição'}</td>
          <td>
            <button class="btn-action btn-edit" data-id="${o.id}"><i class="fas fa-edit"></i> Editar</button>
            <button class="btn-action btn-delete" data-id="${o.id}"><i class="fas fa-trash"></i> Excluir</button>
          </td>`;
        registrosTableBody.appendChild(tr);
      }

      function formatDate(s) {
        const d = new Date(s);
        if (isNaN(d)) return s || '';
        return d.toLocaleDateString('pt-BR');
      }

      registrosTableBody.addEventListener('click', async (ev)=>{
        const btn = ev.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (btn.classList.contains('btn-edit')) {
          try {
            const occ = await api.getOccurrenceById(id);
            professorSelect.value = occ.professor;
            document.getElementById('occurrenceDate').value = occ.date;
            classSelect.value = occ.class;
            const students = await api.getStudents(occ.class);
            studentSelect.innerHTML = '<option value="">Selecione um aluno</option>';
            students.forEach(s=> {
              const opt = document.createElement('option'); opt.value=s; opt.textContent=s;
              studentSelect.appendChild(opt);
            });
            studentSelect.disabled = false;
            studentSelect.value = occ.student;
            document.getElementById('description').value = occ.description || '';
            document.querySelectorAll('input[name="irregularity"]').forEach(ch=>{
              ch.checked = (occ.irregularities || '').includes(ch.value);
            });
            currentEditId = id;
            submitBtn.innerHTML = '<i class="fas fa-save"></i> ATUALIZAR';
            document.querySelector('[data-tab="form-tab"]').click();
            showNotification('success','Ocorrência carregada para edição');
          } catch (err) {
            showNotification('error','Erro ao carregar ocorrência: '+err.message);
          }
        }
        if (btn.classList.contains('btn-delete')) {
          if (!confirm('Tem certeza que deseja excluir esta ocorrência?')) return;
          try {
            await api.deleteOccurrence(id);
            showNotification('success','Ocorrência excluída com sucesso!');
            await loadRegistrosTable();
            await loadInitialData();
          } catch (err) {
            showNotification('error','Erro ao excluir ocorrência: '+err.message);
          }
        }
      });

      async function loadStatistics() {
        try {
          const s = await api.getStatistics();
          document.getElementById('totalOccurrencesStats').textContent = s.totalOccurrences || 0;
          document.getElementById('mostFrequentIrregularity').textContent = s.mostFrequentIrregularity || '-';
          document.getElementById('mostAffectedClass').textContent = s.mostAffectedClass || '-';
        } catch (err) {
          showNotification('error','Erro ao carregar estatísticas: '+err.message);
        }
      }

      async function loadInitialData() {
        try {
          const occurrences = await api.getAllOccurrences();
          totalOccurrencesEl.textContent = occurrences.length;
        } catch (err) {
          showNotification('error','Erro ao carregar dados iniciais: '+err.message);
        }
      }

      // Exportar para XLSX
      exportBtn.addEventListener('click', async ()=>{
        try {
          const occurrences = await api.getAllOccurrences();
          const rows = occurrences.map(o=>({
            ID: o.id, Data: o.date, Professor: o.professor, Turma: o.class,
            Aluno: o.student, Irregularidades: o.irregularities, Descrição: o.description
          }));
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(rows);
          XLSX.utils.book_append_sheet(wb, ws, 'Ocorrencias');
          XLSX.writeFile(wb, `ocorrencias_${new Date().toISOString().slice(0,10)}.xlsx`);
        } catch (err) {
          showNotification('error','Erro ao exportar: '+err.message);
        }
      });

      // Inicialização
      resetAllCharts();
      loadInitialData();
    });
  </script>
</body>
</html>
