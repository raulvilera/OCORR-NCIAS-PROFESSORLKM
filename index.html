<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Ocorrências - 2025</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    /* --- CSS preservado --- */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #e6f2ff 0%, #e6ffe6 60%, #e6f9ff 100%);
      color:#333; font-weight:500; padding:20px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:20px}
    header{display:flex;align-items:center;justify-content:space-between;padding:20px;border-radius:12px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));box-shadow:0 8px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1);}
    header h1{font-size:22px;margin:0;color:#fff;}
    .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.1);border:1px solid #e0e0e0;}
    .flex-row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
    .flex-col{display:flex;flex-direction:column;gap:14px;}
    .form-section{background:#f0f0f0;padding:20px;border-radius:10px;margin-bottom:18px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.05);border:1px solid #d0d0d0}
    label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:#444;}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:14px;color:#333;background:#fff;transition:border-color .2s, box-shadow .2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);}
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    button{cursor:pointer;border:none;padding:12px 18px;border-radius:8px;font-weight:600;transition:all .2s}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .subtitle{font-size:18px;color:#2a5298;margin-bottom:14px;font-weight:600;padding-bottom:8px;border-bottom:2px solid #2a5298}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
    .historyItem{background:#f9f9f9;border-left:4px solid #2a5298;padding:18px;border-radius:8px;color:#333}
    .studentList{display:flex;flex-direction:column;gap:10px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 14px;border-radius:20px;font-weight:600;display:inline-block}
    .muted{opacity:.7;color:#666}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;padding:20px;border-radius:10px;max-height:84vh;overflow:auto}
    .student-checkbox{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid #eee}
    .login-options{display:flex;gap:12px}
    .login-option{flex:1;padding:14px;border-radius:8px;background:rgba(255,255,255,0.12);text-align:center;cursor:pointer}
    .login-option.active{background:linear-gradient(90deg,rgba(0,78,120,0.8),rgba(0,120,120,0.8));color:#fff}
    .success-message{display:none;margin-top:12px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff;font-weight:700}
    @media(max-width:980px){.flex-row{flex-direction:column}}
    .row{display:flex;gap:12px}
    .field{flex:1}
    .small{flex:0 0 220px}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>2025 — Cadastro de Ocorrências</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userDisplay" class="muted">Não autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card">
      <div style="max-width:720px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>
        <div class="login-options" style="margin-bottom:16px">
          <div id="optionGestao" class="login-option active" onclick="selectLoginOption('gestao')">Acesso Gestão</div>
          <div id="optionProfessor" class="login-option" onclick="selectLoginOption('professor')">Acesso Professor</div>
        </div>

        <div id="loginFormGestao" class="access-area" style="display:block">
          <div class="form-section">
            <div class="row">
              <div class="field">
                <label for="emailGestao">E-mail Gestão</label>
                <input id="emailGestao" type="email" placeholder="gestao@escola.com">
              </div>
              <div class="field small">
                <label for="passwordGestao">Senha</label>
                <input id="passwordGestao" type="password" placeholder="senha">
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn-primary" onclick="login('gestao')">Entrar como Gestão</button>
              <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gestão</button>
            </div>
          </div>
        </div>

        <div id="loginFormProfessor" class="access-area" style="display:none">
          <div class="form-section">
            <div class="row">
              <div class="field">
                <label for="emailProfessor">E-mail Professor</label>
                <input id="emailProfessor" type="email" placeholder="professor@escola.com">
              </div>
              <div class="field small">
                <label for="passwordProfessor">Senha</label>
                <input id="passwordProfessor" type="password" placeholder="senha">
              </div>
            </div>
            <div style="margin-top:12px">
              <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:16px">
      <div class="card">
        <div class="subtitle">CADASTRO — GESTÃO</div>
        <div class="form-section">
          <div class="row">
            <div class="field">
              <label>Série / Turma</label>
              <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                <option value="">Selecione a turma</option>
              </select>
            </div>
            <div class="field">
              <label>Aluno(s)</label>
              <div class="student-selector" onclick="openStudentsModalGestao()">
                <span id="aluno_gestao_placeholder">Selecione a turma e depois clique para escolher os alunos</span>
              </div>
              <div id="selectedPillsGestao" style="margin-top:10px"></div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>RA(s)</label>
              <input id="ra_gestao" type="text" readonly placeholder="RAs aparecerão aqui">
            </div>
            <div class="field">
              <label>Professor</label>
              <input id="professor_gestao" type="text">
            </div>
            <div class="field">
              <label>Disciplina</label>
              <input id="disciplina_gestao" type="text">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Classificação</label>
              <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                <option value="">Selecione</option>
                <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                <option value="SUSPENSÃO">SUSPENSÃO</option>
              </select>
            </div>
            <div class="field" id="suspensionRow_gestao" style="display:none">
              <label>Data de retorno</label>
              <input id="dataRetorno_gestao" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Descrição</label>
            <textarea id="descricao_gestao" placeholder="Descrição detalhada"></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
            <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
          </div>

          <div id="successGestao" class="success-message">Ocorrência registrada com sucesso!</div>
        </div>
      </div>

      <!-- HISTÓRICO GESTÃO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
          <div><button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button></div>
        </div>
        <div id="historyListGestao" class="historyList"></div>
      </div>
    </div>

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:16px">
      <div class="card">
        <div class="subtitle">REGISTRO — PROFESSOR</div>
        <div class="form-section">
          <div class="row">
            <div class="field">
              <label>Professor</label>
              <select id="professor_select"></select>
            </div>
            <div class="field">
              <label>Turma</label>
              <select id="turma_select" onchange="onTurmaChange()"></select>
            </div>
            <div class="field small">
              <label>Data</label>
              <input id="data_prof" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Alunos (clique para selecionar)</label>
            <div class="student-selector" onclick="openStudentsModal()">
              <span id="alunos_selected_placeholder">Clique para selecionar</span>
            </div>
            <div id="selectedPills" style="margin-top:10px"></div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="field">
              <label>RA(s)</label>
              <input id="ra_prof" type="text" readonly placeholder="RAs aparecerão aqui">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Irregularidades</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
              <label><input type="checkbox" name="irreg" value="Agressão"> Agressão</label>
              <label><input type="checkbox" name="irreg" value="Danos ao patrimônio"> Danos ao patrimônio</label>
              <label><input type="checkbox" name="irreg" value="Desacato"> Desacato</label>
              <label><input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala</label>
              <label><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
              <label><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
              <label><input type="checkbox" name="irreg" value="Não realiza as atividades"> Não realiza as atividades</label>
              <label><input type="checkbox" name="irreg" value="Saiu da sala sem autorização"> Saiu da sala sem autorização</label>
              <label><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Descrição</label>
            <textarea id="descricao_prof" placeholder="Descreva a ocorrência..."></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
            <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
          </div>

          <div id="successProfessor" class="success-message">Ocorrência registrada com sucesso!</div>
        </div>
      </div>

      <!-- HISTÓRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
          <div><button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button></div>
        </div>
        <div id="historyListProfessor" class="historyList"></div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS PROFESSOR -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Selecionar alunos (Professor)</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
        </div>
        <div style="margin-bottom:12px">
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" oninput="filterStudentList()">
        </div>
        <div id="studentList" class="studentList"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS GESTÃO -->
    <div id="modalRootGestao" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Selecionar alunos (Gestão)</strong>
          <button onclick="closeStudentsModalGestao()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
        </div>
        <div style="margin-bottom:12px">
          <input id="studentSearchGestao" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" oninput="filterStudentListGestao()">
        </div>
        <div id="studentListGestao" class="studentList"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudentsGestao()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModalGestao()">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
    <!-- (LOGIN, APP GESTÃO, APP PROFESSOR, MODAIS) -->
    <!-- ... [conteúdo preservado do HTML que você já forneceu] ... -->
  </div>

  <script>
    /*******************************
     * CONFIGURAÇÕES
     *******************************/
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxoWT4GnKTxWczJGEW_EX3aW78jBqCTPSzNVwQuvIp0U17fdoHnqOweMhTlWh1OmbMt/exec';

    const SHEET_GERAL = 'BANCODEDADOSGERAL';
    const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
    const SHEET_GESTAO = 'BANCODEALUNOS';

    /* --- PRINCIPAIS CORREÇÕES ---
       1. Todas chamadas de POST agora têm ?endpoint=XYZ.
       2. GET mantém ?endpoint=XYZ.
    */

    async function carregarProfessoresETurmas(){
      try {
        const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers&sheet=${encodeURIComponent(SHEET_GERAL)}`);
        const j1 = await r1.json();
        professores = j1.teachers || [];
        const profSel = document.getElementById('professor_select');
        profSel.innerHTML = '<option value="">-- selecione --</option>';
        professores.forEach(p => {
          const o = document.createElement('option'); o.value=p; o.textContent=p; profSel.appendChild(o)
        });
      } catch(err){ console.error('Erro carregar professores:', err); }
    }

    async function cadastrarOcorrenciaGestao(){
      const payload = { sheet: SHEET_GESTAO, date: new Date().toISOString().split('T')[0], professor: document.getElementById('professor_gestao').value, studentClass: document.getElementById('serie_gestao').value, student: alunosSelecionadosGestao.map(a=>a.nome).join(', '), ra: document.getElementById('ra_gestao').value, disciplina: document.getElementById('disciplina_gestao').value, irregularities: document.getElementById('classificacao_gestao').value, description: document.getElementById('descricao_gestao').value };
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=add-occurrence`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j.status==='success'){ document.getElementById('successGestao').style.display='block'; setTimeout(()=> document.getElementById('successGestao').style.display='none',2200); carregarHistoricoGestao(); }
      } catch(err){ console.error(err); alert('Erro ao registrar'); }
    }

    async function registrarOcorrenciaProfessor(){
      const payload = { sheet: SHEET_PROF, date: document.getElementById('data_prof').value, professor: document.getElementById('professor_select').value, studentClass: document.getElementById('turma_select').value, student: alunosSelecionados.map(a=>a.nome).join(', '), ra: alunosSelecionados.map(a=>a.ra).join(', '), irregularities: Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value).join(', '), description: document.getElementById('descricao_prof').value };
      try {
        const resp = await fetch(`${SCRIPT_URL}?endpoint=add-occurrence`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        const j = await resp.json();
        if(j.status==='success'){ document.getElementById('successProfessor').style.display='block'; setTimeout(()=> document.getElementById('successProfessor').style.display='none',2200); carregarHistoricoProfessor(); }
      } catch(err){ console.error(err); alert('Erro ao registrar'); }
    }

    async function carregarHistoricoGestao(){
      const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${SHEET_GESTAO}`);
      const json = await resp.json();
      renderHistorico(json.occurrences, 'historyListGestao');
    }

    async function carregarHistoricoProfessor(){
      const resp = await fetch(`${SCRIPT_URL}?endpoint=occurrences&sheet=${SHEET_PROF}`);
      const json = await resp.json();
      renderHistorico(json.occurrences, 'historyListProfessor');
    }

    function renderHistorico(list, containerId){
      const container=document.getElementById(containerId); container.innerHTML='';
      list.slice().reverse().forEach(r=>{
        const div=document.createElement('div'); div.className='historyItem';
        div.innerHTML = `<strong>${r.DATA}</strong> — ${r.PROFESSOR}<br>Aluno(s): ${r.ALUNO} | Turma: ${r.TURMA}`;
        container.appendChild(div);
      });
    }

    async function deleteOccurrence(id,sheet){
      await fetch(`${SCRIPT_URL}?endpoint=delete-occurrence`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sheet,occurrenceId:id})});
      if(sheet===SHEET_GESTAO) carregarHistoricoGestao(); else carregarHistoricoProfessor();
    }

    async function generatePdfFromBackend(id,sheet){
      const r=await fetch(`${SCRIPT_URL}?endpoint=generate-pdf`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({sheet,occurrenceId:id})});
      const j=await r.json(); if(j.pdfUrl) window.open(j.pdfUrl,'_blank');
    }

    function downloadDocument(){
      alert("Baixar template direto do servidor: use endpoint=generate-pdf-form se desejar.");
    }
  </script>
</body>
</html>
