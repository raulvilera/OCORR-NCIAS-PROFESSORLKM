<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cadastro de Ocorrências - 2025</title>

  <!-- jsPDF para geração local de PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    /* ===== Reset/Base ===== */
    * { box-sizing: border-box; margin:0; padding:0; }
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Roboto, Arial, sans-serif;
      background: linear-gradient(135deg, #e6f2ff 0%, #e6ffe6 60%, #e6f9ff 100%);
      color:#333; font-weight:500; padding:20px;
    }
    .app{max-width:1200px;margin:0 auto;display:flex;flex-direction:column;gap:20px}
    header{
      display:flex;align-items:center;justify-content:space-between;padding:20px;
      border-radius:12px;background:linear-gradient(90deg,rgba(0,31,63,0.95),rgba(0,78,120,0.95));
      box-shadow:0 8px 30px rgba(0,0,0,0.15); border: 1px solid rgba(255,255,255,0.1);
    }
    header h1{font-size:22px;margin:0;color:#fff;}
    .card{background:#fff;padding:24px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.1);border:1px solid #e0e0e0;}
    .flex-row{display:flex;gap:18px;align-items:flex-start;flex-wrap:wrap;}
    .flex-col{display:flex;flex-direction:column;gap:14px;}
    .form-section{background:#f0f0f0;padding:20px;border-radius:10px;margin-bottom:18px;box-shadow:inset 0 2px 4px rgba(0,0,0,0.05);border:1px solid #d0d0d0}
    label{display:block;margin-bottom:8px;font-size:14px;font-weight:600;color:#444;}
    input[type="text"],input[type="email"],input[type="password"],select,textarea,input[type="date"]{
      width:100%;padding:12px;border-radius:8px;border:1px solid #ddd;font-size:14px;color:#333;background:#fff;
      transition:border-color .2s, box-shadow .2s; box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    textarea{min-height:110px;resize:vertical;padding-top:12px}
    button{cursor:pointer;border:none;padding:12px 18px;border-radius:8px;font-weight:600;transition:all .2s}
    .btn-primary{background:linear-gradient(90deg,#1e3c72,#2a5298);color:#fff}
    .btn-success{background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff}
    .btn-danger{background:linear-gradient(90deg,#e94b4b,#c62828);color:#fff}
    .subtitle{font-size:18px;color:#2a5298;margin-bottom:14px;font-weight:600;padding-bottom:8px;border-bottom:2px solid #2a5298}
    .historyList{max-height:420px;overflow:auto;display:flex;flex-direction:column;gap:12px;padding-right:8px}
    .historyItem{background:#f9f9f9;border-left:4px solid #2a5298;padding:18px;border-radius:8px;color:#333}
    .studentList{display:flex;flex-direction:column;gap:10px}
    .pill{background:linear-gradient(90deg,#2a5298,#3a6bd1);color:#fff;padding:6px 14px;border-radius:20px;font-weight:600;display:inline-block}
    .muted{opacity:.7;color:#666}
    .modal-root{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:2000}
    .modal{width:92%;max-width:780px;background:#fff;padding:20px;border-radius:10px;max-height:84vh;overflow:auto}
    .student-checkbox{display:flex;align-items:center;gap:12px;padding:10px;border-bottom:1px solid #eee}
    .login-options{display:flex;gap:12px}
    .login-option{flex:1;padding:14px;border-radius:8px;background:rgba(255,255,255,0.12);text-align:center;cursor:pointer}
    .login-option.active{background:linear-gradient(90deg,rgba(0,78,120,0.8),rgba(0,120,120,0.8));color:#fff}
    .success-message{display:none;margin-top:12px;padding:12px;border-radius:8px;background:linear-gradient(90deg,#4CAF50,#2E7D32);color:#fff;font-weight:700}
    @media(max-width:980px){.flex-row{flex-direction:column}}
    .row{display:flex;gap:12px}
    .field{flex:1}
    .small{flex:0 0 220px}
  </style>
</head>
<body>
  <div class="app">
</head>
<body>
  <div class="app">
    <header>
      <h1>2025 — Cadastro de Ocorrências</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="userDisplay" class="muted">Não autenticado</div>
        <button id="btnLogout" class="btn-danger" style="display:none" onclick="logout()">Sair</button>
        <button id="btnDownloadPdf" class="btn-success" style="display:none" onclick="downloadDocument()">Baixar Template</button>
      </div>
    </header>

    <!-- LOGIN -->
    <div id="loginScreen" class="card">
      <div style="max-width:720px;margin:0 auto">
        <div class="subtitle">Selecione o tipo de acesso</div>
        <div class="login-options" style="margin-bottom:16px">
          <div id="optionGestao" class="login-option active" onclick="selectLoginOption('gestao')">Acesso Gestão</div>
          <div id="optionProfessor" class="login-option" onclick="selectLoginOption('professor')">Acesso Professor</div>
        </div>

        <div id="loginFormGestao" class="access-area" style="display:block">
          <div class="form-section">
            <div class="row">
              <div class="field">
                <label for="emailGestao">E-mail Gestão</label>
                <input id="emailGestao" type="email" placeholder="gestao@escola.com">
              </div>
              <div class="field small">
                <label for="passwordGestao">Senha</label>
                <input id="passwordGestao" type="password" placeholder="senha">
              </div>
            </div>
            <div style="margin-top:12px;display:flex;gap:8px">
              <button class="btn-primary" onclick="login('gestao')">Entrar como Gestão</button>
              <button class="btn-danger" onclick="fillDemo('gestao')">Demo Gestão</button>
            </div>
          </div>
        </div>

        <div id="loginFormProfessor" class="access-area" style="display:none">
          <div class="form-section">
            <div class="row">
              <div class="field">
                <label for="emailProfessor">E-mail Professor</label>
                <input id="emailProfessor" type="email" placeholder="professor@escola.com">
              </div>
              <div class="field small">
                <label for="passwordProfessor">Senha</label>
                <input id="passwordProfessor" type="password" placeholder="senha">
              </div>
            </div>
            <div style="margin-top:12px">
              <button class="btn-primary" onclick="login('professor')">Entrar como Professor</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MAIN APP - GESTÃO -->
    <div id="mainAppGestao" style="display:none;flex-direction:column;gap:16px">
      <div class="card">
        <div class="subtitle">CADASTRO — GESTÃO</div>
        <div class="form-section">
          <div class="row">
            <div class="field">
              <label>Série / Turma</label>
              <select id="serie_gestao" onchange="carregarAlunosPorTurmaGestao(this.value)">
                <option value="">Selecione a turma</option>
              </select>
            </div>
            <div class="field">
              <label>Aluno(s)</label>
              <div class="student-selector" onclick="openStudentsModalGestao()">
                <span id="aluno_gestao_placeholder">Selecione a turma e depois clique para escolher os alunos</span>
              </div>
              <div id="selectedPillsGestao" style="margin-top:10px"></div>
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>RA(s)</label>
              <input id="ra_gestao" type="text" readonly placeholder="RAs aparecerão aqui">
            </div>
            <div class="field">
              <label>Professor</label>
              <input id="professor_gestao" type="text">
            </div>
            <div class="field">
              <label>Disciplina</label>
              <input id="disciplina_gestao" type="text">
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div class="field">
              <label>Classificação</label>
              <select id="classificacao_gestao" onchange="toggleSuspension('gestao')">
                <option value="">Selecione</option>
                <option value="OCORRÊNCIA">OCORRÊNCIA</option>
                <option value="SUSPENSÃO">SUSPENSÃO</option>
              </select>
            </div>
            <div class="field" id="suspensionRow_gestao" style="display:none">
              <label>Data de retorno</label>
              <input id="dataRetorno_gestao" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Descrição</label>
            <textarea id="descricao_gestao" placeholder="Descrição detalhada"></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" onclick="cadastrarOcorrenciaGestao()">Registrar (Gestão)</button>
            <button class="btn-success" onclick="generatePDFLocal()">Gerar PDF (local)</button>
          </div>

          <div id="successGestao" class="success-message">Ocorrência registrada com sucesso!</div>
        </div>
      </div>

      <!-- HISTÓRICO GESTÃO -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - GESTÃO</div>
          <div><button class="btn-primary" onclick="carregarHistoricoGestao()">Atualizar</button></div>
        </div>
        <div id="historyListGestao" class="historyList"></div>
      </div>
    </div>

    <!-- MAIN APP - PROFESSOR -->
    <div id="mainAppProfessor" style="display:none;flex-direction:column;gap:16px">
      <div class="card">
        <div class="subtitle">REGISTRO — PROFESSOR</div>
        <div class="form-section">
          <div class="row">
            <div class="field">
              <label>Professor</label>
              <select id="professor_select"></select>
            </div>
            <div class="field">
              <label>Turma</label>
              <select id="turma_select" onchange="onTurmaChange()"></select>
            </div>
            <div class="field small">
              <label>Data</label>
              <input id="data_prof" type="date">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Alunos (clique para selecionar)</label>
            <div class="student-selector" onclick="openStudentsModal()">
              <span id="alunos_selected_placeholder">Clique para selecionar</span>
            </div>
            <div id="selectedPills" style="margin-top:10px"></div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="field">
              <label>RA(s)</label>
              <input id="ra_prof" type="text" readonly placeholder="RAs aparecerão aqui">
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Irregularidades</label>
            <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">
              <label><input type="checkbox" name="irreg" value="Agressão"> Agressão</label>
              <label><input type="checkbox" name="irreg" value="Danos ao patrimônio"> Danos ao patrimônio</label>
              <label><input type="checkbox" name="irreg" value="Desacato"> Desacato</label>
              <label><input type="checkbox" name="irreg" value="Estava fora da sala"> Estava fora da sala</label>
              <label><input type="checkbox" name="irreg" value="Falta de material"> Falta de material</label>
              <label><input type="checkbox" name="irreg" value="Indisciplina"> Indisciplina</label>
              <label><input type="checkbox" name="irreg" value="Não realiza as atividades"> Não realiza as atividades</label>
              <label><input type="checkbox" name="irreg" value="Saiu da sala sem autorização"> Saiu da sala sem autorização</label>
              <label><input type="checkbox" name="irreg" value="Uso de celular"> Uso de celular</label>
            </div>
          </div>

          <div style="margin-top:12px">
            <label>Descrição</label>
            <textarea id="descricao_prof" placeholder="Descreva a ocorrência..."></textarea>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button class="btn-primary" onclick="registrarOcorrenciaProfessor()">Registrar (Professor)</button>
            <button class="btn-danger" onclick="clearProfessorForm()">Limpar</button>
          </div>

          <div id="successProfessor" class="success-message">Ocorrência registrada com sucesso!</div>
        </div>
      </div>

      <!-- HISTÓRICO PROFESSOR -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div class="subtitle">HISTÓRICO DE OCORRÊNCIAS - PROFESSOR</div>
          <div><button class="btn-primary" onclick="carregarHistoricoProfessor()">Atualizar</button></div>
        </div>
        <div id="historyListProfessor" class="historyList"></div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS PROFESSOR -->
    <div id="modalRoot" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Selecionar alunos (Professor)</strong>
          <button onclick="closeStudentsModal()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
        </div>
        <div style="margin-bottom:12px">
          <input id="studentSearch" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" oninput="filterStudentList()">
        </div>
        <div id="studentList" class="studentList"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudents()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModal()">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- MODAL SELEÇÃO ALUNOS GESTÃO -->
    <div id="modalRootGestao" class="modal-root">
      <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <strong>Selecionar alunos (Gestão)</strong>
          <button onclick="closeStudentsModalGestao()" style="background:transparent;border:none;font-size:18px;cursor:pointer">✕</button>
        </div>
        <div style="margin-bottom:12px">
          <input id="studentSearchGestao" type="text" placeholder="Filtrar alunos..." style="width:100%;padding:10px;border-radius:6px;border:1px solid #ddd" oninput="filterStudentListGestao()">
        </div>
        <div id="studentListGestao" class="studentList"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button class="btn-primary" onclick="confirmStudentsGestao()">Confirmar</button>
          <button class="btn-danger" onclick="closeStudentsModalGestao()">Cancelar</button>
        </div>
      </div>
    </div>

  </div>

  <script>

  <script>
  /*******************************
   * CONFIGURAÇÕES
   *******************************/
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVifmOWPfIKlUYbHe_VOPdCeOdm2kZcG2fMIeXFWUjJ07Xu58EKIlExt6wlYvSh3rj/exec';
  const SHEET_PROF = 'OCORRENCIASDOSPROFESSORES';
  const SHEET_GESTAO = 'BANCODEALUNOS';

  // estado
  let alunosDaTurmaAtual = [];
  let alunosSelecionados = [];
  let alunosDaTurmaAtualGestao = [];
  let alunosSelecionadosGestao = [];
  let professores = [];
  let turmas = [];

  // inicialização
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('data_prof').value = new Date().toISOString().split('T')[0];
    selectLoginOption('gestao');
    carregarProfessoresETurmas();
  });

  /* -------------------------
     Carregar professores e turmas (professor/gestão)
     ------------------------- */
  async function carregarProfessoresETurmas(){
    try {
      // Professores
      const r1 = await fetch(`${SCRIPT_URL}?endpoint=teachers`);
      const j1 = await r1.json();
      if(j1 && j1.status === 'success' && Array.isArray(j1.teachers)) professores = j1.teachers;

      const profSel = document.getElementById('professor_select');
      profSel.innerHTML = '<option value="">-- selecione --</option>';
      professores.forEach(p => { const o = document.createElement('option'); o.value=p; o.textContent=p; profSel.appendChild(o) });

      // Turmas
      const r2 = await fetch(`${SCRIPT_URL}?endpoint=classes`);
      const j2 = await r2.json();
      if(j2 && j2.status === 'success' && Array.isArray(j2.classes)) {
        const turmaSel = document.getElementById('turma_select');
        turmaSel.innerHTML = '<option value="">-- selecione --</option>';
        j2.classes.forEach(t => { const o = document.createElement('option'); o.value=t; o.textContent=t; turmaSel.appendChild(o) });

        const selG = document.getElementById('serie_gestao');
        selG.innerHTML = '<option value="">Selecione a turma</option>';
        j2.classes.forEach(t => { const o = document.createElement('option'); o.value=t; o.textContent=t; selG.appendChild(o) });
      }
    } catch(err){
      console.error('Erro carregar professores/turmas:', err);
    }
  }

  /* -------------------------
     Carregar alunos (corrigido, sem sheet)
     ------------------------- */
  async function carregarAlunosPorTurma(turma){
    alunosDaTurmaAtual = [];
    try {
      const resp = await fetch(`${SCRIPT_URL}?endpoint=students&turma=${encodeURIComponent(turma)}`);
      const json = await resp.json();
      if(json && Array.isArray(json.studentsList)) alunosDaTurmaAtual = json.studentsList;
    } catch(err){ console.error('Erro get students:', err); }
  }

  async function carregarAlunosPorTurmaGestao(turma){
    alunosDaTurmaAtualGestao = [];
    try {
      const resp = await fetch(`${SCRIPT_URL}?endpoint=students&turma=${encodeURIComponent(turma)}`);
      const json = await resp.json();
      if(json && Array.isArray(json.studentsList)) alunosDaTurmaAtualGestao = json.studentsList;
    } catch(err){ console.error('Erro get students gestão:', err); }
  }

  /* -------------------------
     Registrar ocorrências corrigido
     ------------------------- */
  async function registrarOcorrenciaProfessor(){
    const professor = document.getElementById('professor_select').value;
    const turma = document.getElementById('turma_select').value;
    const dataOc = document.getElementById('data_prof').value;
    const descricao = document.getElementById('descricao_prof').value.trim();
    const irregs = Array.from(document.querySelectorAll('input[name="irreg"]:checked')).map(x=>x.value);

    const payload = {
      sheet: SHEET_PROF,
      date: dataOc,
      professor: professor,
      studentClass: turma,
      student: alunosSelecionados.map(a=>a.nome).join(', '),
      irregularities: irregs.join(', '),
      description: descricao
    };

    await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  }

  async function cadastrarOcorrenciaGestao(){
    const turma = document.getElementById('serie_gestao').value.trim();
    const alunos = alunosSelecionadosGestao.map(a=>a.nome).join(', ');
    const ras = alunosSelecionadosGestao.map(a=>a.ra).join(', ');
    const professor = document.getElementById('professor_gestao').value.trim();
    const disciplina = document.getElementById('disciplina_gestao').value.trim();
    const classificacao = document.getElementById('classificacao_gestao').value;
    const descricao = document.getElementById('descricao_gestao').value.trim();

    const payload = {
      sheet: SHEET_GESTAO,
      date: new Date().toISOString().split('T')[0],
      professor, studentClass: turma, student: alunos, ra: ras,
      disciplina, irregularities: classificacao, description: descricao
    };

    await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
  }
  </script>
</body>
</html>
